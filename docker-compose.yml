services:
  # Odoo 18 Web Application Service
  web:
    image: odoo:18.0
    container_name: ${COMPOSE_PROJECT_NAME:-woow_paas_platform}_web
    # 條件性依賴：僅在非共享模式下依賴 db
    depends_on:
      db:
        condition: service_started
        required: false
    restart: "no"
    ports:
      - "${ODOO_PORT:-8069}:8069"
    volumes:
      # Odoo configuration
      - ./config/odoo:/etc/odoo
      # Custom addons - mount src directory as the addon
      - ./src:/mnt/extra-addons/woow_paas_platform
      # Odoo data persistence
      - odoo-data:/var/lib/odoo
    environment:
      - HOST=${POSTGRES_HOST:-db}
      - USER=${POSTGRES_USER:-odoo}
      - PASSWORD=${POSTGRES_PASSWORD:-odoo}
      - POSTGRES_HOST=${POSTGRES_HOST:-db}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_USER=${POSTGRES_USER:-odoo}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-odoo}
      - ODOO_DB_NAME=${ODOO_DB_NAME:-woow_main}
    networks:
      - default
      - shared

  # PostgreSQL Database Service
  # 僅在獨立模式啟動（USE_SHARED_DB=false 或未設定）
  # 使用 --profile standalone 或設定 COMPOSE_PROFILES=standalone
  db:
    image: postgres:15
    container_name: ${COMPOSE_PROJECT_NAME:-woow_paas_platform}_db
    restart: "no"
    volumes:
      - postgresql-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-odoo}
      - POSTGRES_USER=${POSTGRES_USER:-odoo}
      - POSTGRES_DB=postgres
    networks:
      - default
    profiles:
      - standalone

  # Nginx Reverse Proxy (optional)
  nginx:
    image: nginx:alpine
    restart: "no"
    volumes:
      - ./nginx:/etc/nginx/conf.d
    ports:
      - "8000:80"
    environment:
      - NGINX_PORT=80
    depends_on:
      - web
    profiles:
      - full

  # PgAdmin Database Management (optional)
  pgadmin:
    image: dpage/pgadmin4
    restart: "no"
    depends_on:
      db:
        condition: service_started
        required: false
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL:-admin@woow.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD:-admin}
    volumes:
      - pgadmin-data:/root/.pgadmin
    ports:
      - "5050:80"
    profiles:
      - full

volumes:
  odoo-data:
    name: ${COMPOSE_PROJECT_NAME:-woow_paas_platform}_odoo_data
  postgresql-data:
    name: ${COMPOSE_PROJECT_NAME:-woow_paas_platform}_postgres_data
  pgadmin-data:
    name: ${COMPOSE_PROJECT_NAME:-woow_paas_platform}_pgadmin_data

networks:
  default:
    name: ${COMPOSE_PROJECT_NAME:-woow_paas_platform}_network
  shared:
    name: ${SHARED_DB_NETWORK:-odoo_network}
    external: true
