---
name: Refactor controller API endpoints to use ai.assistant
status: open
created: 2026-02-21T16:13:06Z
updated: 2026-02-20T16:21:24Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/72
depends_on: [77]
parallel: true
conflicts_with: []
---

# Task: Refactor controller API endpoints to use ai.assistant

## Description

重構 `controllers/ai_assistant.py` 的所有 AI 相關 API endpoints，改用 `ai.assistant` 和 `AIClient.from_assistant()`。這是最大的 task，因為 controller 有 ~998 行。

## Acceptance Criteria

- [ ] `/api/ai/providers` — 改為查詢 `ai.config`（或移除，視前端需求）
- [ ] `/api/ai/agents` — 改為查詢 `ai.assistant`，返回格式包含 `id`、`name`（partner name）、`description`
- [ ] `/api/ai/chat/post` — AI 呼叫改用 `AIClient.from_assistant()`，assistant 從 settings 或 channel 關聯取得
- [ ] `/api/ai/stream/<channel_id>` — SSE streaming 改用 `AIClient.from_assistant()` + LangChain streaming
- [ ] `/api/ai/connection-status` — 改為檢測預設 `ai.config` 的連線狀態
- [ ] 所有 helper 方法（`_get_channel_agent`、`_get_default_provider` 等）更新為使用 `ai.assistant`
- [ ] API response 格式盡量保持一致，必要時記錄變更供 Task 74 前端適配

## Technical Details

**修改檔案：**
- `src/controllers/ai_assistant.py`

**關鍵重構點：**

1. **`_get_channel_agent(channel)`** → `_get_channel_assistant(channel)`
   - 從 task 的 ai_auto_reply 取得預設 assistant（從 settings）
   - 或從 channel 成員中找到 `ai.assistant` 的 partner

2. **`_get_default_provider()`** → 改為 `_get_default_assistant()`
   - 從 `ir.config_parameter` 讀取 `woow_paas_platform.default_ai_assistant_id`

3. **SSE streaming handler**:
   - 原本：從 `ai_provider` 取配置 → `AIClient(...)` → `chat_completion_stream()`
   - 改為：從 `ai.assistant` → `AIClient.from_assistant()` → `chat_completion_stream()`
   - AI 回覆的 author_id 改為 `assistant.partner_id`

4. **system_prompt 來源**:
   - 原本：`agent.system_prompt`
   - 改為：`assistant.context_id.content`（需確認 `ai.context` 的欄位名稱）

**注意：** Support/Project/Task CRUD endpoints（`/api/support/*`）不涉及 AI 呼叫，不需改動。

## Dependencies

- [ ] Task 77 完成（`AIClient.from_assistant()` 可用）

## Effort Estimate

- Size: L
- Parallel: true（可與 Task 78、75 並行）
