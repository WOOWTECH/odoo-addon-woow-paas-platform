---
name: Refactor ai_client.py with from_assistant() factory method
status: closed
created: 2026-02-21T16:13:06Z
updated: 2026-02-21T08:31:40Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/77
depends_on: [73]
parallel: false
conflicts_with: []
---

# Task: Refactor ai_client.py with from_assistant() factory method

## Description

重構 `ai_client.py`，新增 `AIClient.from_assistant(assistant)` 工廠方法，從 `ai.assistant` → `ai.config` 讀取配置建立 LangChain client。保留原有 `chat_completion()` 和 `chat_completion_stream()` 介面不變。

## Acceptance Criteria

- [ ] `AIClient.from_assistant(assistant)` class method 存在且正常運作
- [ ] 從 `assistant.config_id` 讀取 `api_base_url`、`api_key`、`model`、`max_tokens`、`temperature`
- [ ] 原有的 `AIClient(api_base_url=..., api_key=..., ...)` 建構方式仍可用（向後相容）
- [ ] `chat_completion()` 和 `chat_completion_stream()` 介面不變
- [ ] 異常處理保持一致（`AIClientError` 系列）

## Technical Details

**修改檔案：**
- `src/models/ai_client.py`:
  ```python
  class AIClient:
      @classmethod
      def from_assistant(cls, assistant):
          """從 ai.assistant 建立 LangChain client"""
          config = assistant.sudo().config_id
          if not config:
              raise AIClientError("AI assistant has no configuration")
          return cls(
              api_base_url=config.api_base_url or 'https://api.openai.com/v1',
              api_key=config.api_key,
              model_name=config.model,
              max_tokens=config.max_tokens,
              temperature=config.temperature,
          )
  ```

**注意：**
- `ai.config.api_key` 有 `groups='base.group_system'`，需要 `sudo()` 讀取
- `ai.config.model` 欄位名稱和原本 `ai_provider.model_name` 不同，工廠方法內做映射
- 此 task 不改動任何呼叫端（controller、discuss_channel），僅新增工廠方法

## Dependencies

- [ ] Task 73 完成（`ai_config.py` 存在，`ai_base_gt` 可用）

## Effort Estimate

- Size: S
- Parallel: false（Task 3-5 依賴此 task）
