---
name: Refactor discuss_channel.py AI reply to use ai.assistant
status: open
created: 2026-02-21T16:13:06Z
updated: 2026-02-20T16:21:24Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/75
depends_on: [77]
parallel: true
conflicts_with: []
---

# Task: Refactor discuss_channel.py AI reply to use ai.assistant

## Description

重構 `discuss_channel.py` 的 AI 自動回覆邏輯，從自建 `ai_agent` 改為使用 `ai.assistant`。AI 回覆的 author 改用 `ai.assistant.partner_id`，不再使用 `base.partner_root`。

## Acceptance Criteria

- [ ] `_detect_ai_agent(body)` → `_detect_ai_assistant(body)`：搜尋 `ai.assistant` 比對 partner name（@mention 偵測）
- [ ] `_get_auto_reply_agent()` → `_get_auto_reply_assistant()`：從 settings 取得預設 `ai.assistant`
- [ ] `_post_ai_reply()` 使用 `AIClient.from_assistant(assistant)` 呼叫 LangChain
- [ ] AI 回覆的 `author_id` 使用 `assistant.partner_id`（不再用 `base.partner_root`）
- [ ] system prompt 從 `assistant.context_id` 取得
- [ ] 錯誤通知訊息的 author 也改為 `assistant.partner_id`
- [ ] bus notification 的 agent info 改為 assistant info

## Technical Details

**修改檔案：**
- `src/models/discuss_channel.py`

**關鍵重構點：**

1. **`_detect_ai_assistant(body)`**:
   ```python
   assistants = self.env['ai.assistant'].sudo().search([])
   for assistant in assistants:
       if f'@{assistant.name}' in body:  # name 來自 res.partner
           return assistant
   ```

2. **`_get_auto_reply_assistant()`**:
   ```python
   assistant_id = int(self.env['ir.config_parameter'].sudo().get_param(
       'woow_paas_platform.default_ai_assistant_id', '0'))
   return self.env['ai.assistant'].browse(assistant_id).exists()
   ```

3. **`_post_ai_reply(assistant, ...)`**:
   - `client = AIClient.from_assistant(assistant)`
   - system prompt: `assistant.context_id.content` 或 `''`
   - author_id: `assistant.partner_id.id`
   - bus notification: agent info → assistant info（name, partner_id 等）

4. **`_get_chat_history()`**: 不需改動，已正確使用 Discuss channel messages

## Dependencies

- [ ] Task 77 完成（`AIClient.from_assistant()` 可用）

## Effort Estimate

- Size: M
- Parallel: true（可與 Task 78、72 並行）
