---
name: Refactor smart home naming and add reference_id
status: open
created: 2026-03-01T14:57:06Z
updated: 2026-03-01T15:02:28Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/134
depends_on: [132]
parallel: true
conflicts_with: []
---

# Task: Refactor smart home naming and add reference_id

## Description

為 Smart Home model 新增 `reference_id` 欄位（UUID），重構 subdomain 產生邏輯改用 `paas-sm-{ws_hash}-{sm_hash}` 格式，tunnel name 與 subdomain 一致。包含 database migration 和 manifest version bump。

## Acceptance Criteria

- [ ] Smart Home model 新增 `reference_id = fields.Char()` 欄位，建立時自動產生 UUID
- [ ] `_generate_subdomain()` 改用 `naming.make_smarthome_subdomain()`
- [ ] Tunnel name 等於 subdomain（不再有 `smarthome-` prefix）
- [ ] 新建 smart home 的 subdomain 格式為 `paas-sm-{8hex}-{8hex}`
- [ ] Migration `18.0.1.0.3` 為既有記錄產生 `reference_id`
- [ ] `__manifest__.py` version 升級至 `18.0.1.0.3`

## Technical Details

### Smart Home model 修改 (`src/models/smart_home.py`)

```python
# 新增 reference_id 欄位
reference_id = fields.Char(
    string='Reference ID',
    default=lambda self: str(uuid.uuid4()),
    required=True,
    copy=False,
    index=True,
)

# 修改 _generate_subdomain()
def _generate_subdomain(self):
    from ..services.naming import make_smarthome_subdomain
    return make_smarthome_subdomain(
        self.workspace_id.slug,
        self.reference_id,
        self.name,
    )

# 修改 action_provision() 中的 tunnel name
result = client.create_tunnel(
    name=subdomain,  # was: f"smarthome-{subdomain}"
    ...
)
```

### Migration (`src/migrations/18.0.1.0.3/post-migrate.py`)

```python
def migrate(cr, version):
    # 為既有 smart_home 記錄產生 reference_id
    cr.execute("""
        UPDATE woow_paas_platform_smart_home
        SET reference_id = gen_random_uuid()::text
        WHERE reference_id IS NULL
    """)
```

### Manifest (`src/__manifest__.py`)
- Version: `18.0.1.0.2` → `18.0.1.0.3`

**Files affected:**
- `src/models/smart_home.py` (edit)
- `src/migrations/18.0.1.0.3/post-migrate.py` (new)
- `src/__manifest__.py` (edit version)

## Dependencies

- [ ] Task 001: naming utility module

## Effort Estimate

- Size: S
- Hours: 0.75
- Parallel: true (can run in parallel with Task 002)

## Definition of Done

- [ ] Code implemented
- [ ] reference_id auto-generated on create
- [ ] Migration handles existing records
- [ ] Tunnel name = subdomain (no prefix)
- [ ] Version bumped in manifest
