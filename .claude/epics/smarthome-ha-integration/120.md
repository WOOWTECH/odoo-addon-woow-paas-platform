---
name: End-to-End Testing
status: open
created: 2026-02-28T09:46:09Z
updated: 2026-02-28T09:53:44Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/120
depends_on: [114, 115, 116, 118, 119]
parallel: false
conflicts_with: []
---

# Task: End-to-End Testing

## Description

建立完整的測試覆蓋：PaaS Operator Tunnel API 單元測試、Odoo Smart Home model 測試、OAuth 2.0 flow 測試、HA API endpoint 測試。確保端到端流程可靠運作。

## Acceptance Criteria

- [ ] **PaaS Operator 測試**：Tunnel CRUD API endpoints 單元測試（mock Cloudflare API）
- [ ] **Smart Home Model 測試**：建立/刪除 Smart Home、state machine 轉換、operator client mock
- [ ] **OAuth 2.0 測試**：Authorization Code Flow 完整流程（authorize → code → token → refresh → revoke）
- [ ] **OAuth 安全測試**：過期 code/token 拒絕、scope 驗證、redirect_uri 嚴格比對
- [ ] **HA API 測試**：Bearer Token 認證、scope 權限檢查、正確回傳 workspace/smarthome 資料
- [ ] **整合測試**：建立 Smart Home → 取得 Tunnel Token 端到端
- [ ] 測試通過率 100%

## Technical Details

### PaaS Operator 測試 (pytest)

```python
# extra/paas-operator/tests/test_tunnels.py
class TestTunnelEndpoints:
    def test_create_tunnel(self, client, mock_cloudflare): ...
    def test_get_tunnel_status(self, client, mock_cloudflare): ...
    def test_delete_tunnel(self, client, mock_cloudflare): ...
    def test_get_tunnel_token(self, client, mock_cloudflare): ...
    def test_create_tunnel_cloudflare_error(self, client, mock_cloudflare): ...
```

### Odoo 測試 (TransactionCase)

```python
# src/tests/test_smart_home.py
class TestSmartHome(TransactionCase):
    def test_create_smart_home(self): ...
    def test_delete_smart_home_cleans_tunnel(self): ...
    def test_state_transitions(self): ...

# src/tests/test_oauth2.py
class TestOAuth2Provider(HttpCase):
    def test_authorization_code_flow(self): ...
    def test_token_refresh(self): ...
    def test_token_revocation(self): ...
    def test_expired_token_rejected(self): ...
    def test_invalid_scope_rejected(self): ...

# src/tests/test_ha_api.py
class TestHAApi(HttpCase):
    def test_list_workspaces_with_token(self): ...
    def test_get_tunnel_token(self): ...
    def test_unauthorized_without_token(self): ...
```

### 涉及檔案
- `extra/paas-operator/tests/test_tunnels.py` - 新檔案
- `src/tests/__init__.py` - 確保存在
- `src/tests/test_smart_home.py` - 新檔案
- `src/tests/test_oauth2.py` - 新檔案
- `src/tests/test_ha_api.py` - 新檔案

## Dependencies

- [ ] 所有前置 Tasks (001-005) 需完成

## Effort Estimate

- Size: M
- Hours: 10-14
- Parallel: false（依賴全部 Tasks）
