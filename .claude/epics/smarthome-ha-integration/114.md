---
name: PaaS Operator - Dedicated Tunnel CRUD API
status: open
created: 2026-02-28T09:46:09Z
updated: 2026-02-28T09:53:44Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/114
depends_on: []
parallel: true
conflicts_with: []
---

# Task: PaaS Operator - Dedicated Tunnel CRUD API

## Description

擴充 paas-operator 的 CloudflareService，新增獨立 Cloudflare Tunnel 的建立、查詢狀態、刪除能力。目前 cloudflare.py 只管理共享 Tunnel 的 ingress route，需要新增直接操作 Tunnel 生命週期的方法，並建立對應的 FastAPI endpoints。

## Acceptance Criteria

- [ ] `CloudflareService` 新增 `create_tunnel(name)` 方法，呼叫 Cloudflare API 建立 Tunnel，回傳 tunnel_id + tunnel_token
- [ ] `CloudflareService` 新增 `delete_tunnel(tunnel_id)` 方法，刪除 Tunnel 並清理相關 DNS record
- [ ] `CloudflareService` 新增 `get_tunnel_status(tunnel_id)` 方法，回傳連線狀態、connector 資訊、運作時間
- [ ] `CloudflareService` 新增 `get_tunnel_token(tunnel_id)` 方法，取得已建立 Tunnel 的 token
- [ ] 新增 `src/api/tunnels.py` with endpoints: POST /api/tunnels, GET /api/tunnels/{tunnel_id}, DELETE /api/tunnels/{tunnel_id}, GET /api/tunnels/{tunnel_id}/token
- [ ] 新增 Pydantic schemas (TunnelCreateRequest, TunnelCreateResponse, TunnelStatusResponse)
- [ ] 在 `main.py` 中註冊 tunnels router
- [ ] Tunnel 建立時自動設定 ingress rule：`http://localhost:{port}` + catch-all 404

## Technical Details

### Cloudflare API 呼叫

**建立 Tunnel:**
```
POST https://api.cloudflare.com/client/v4/accounts/{account_id}/cfd_tunnel
Body: { "name": "smarthome-{name}", "tunnel_secret": "..." }
```

**取得 Tunnel Token:**
```
GET https://api.cloudflare.com/client/v4/accounts/{account_id}/cfd_tunnel/{tunnel_id}/token
```

**取得 Tunnel 狀態:**
```
GET https://api.cloudflare.com/client/v4/accounts/{account_id}/cfd_tunnel/{tunnel_id}
```
回傳包含 `status`, `connections[]` (connector_id, type, origin_ip, opened_at)

**刪除 Tunnel:**
```
DELETE https://api.cloudflare.com/client/v4/accounts/{account_id}/cfd_tunnel/{tunnel_id}
```

**設定 Tunnel ingress config:**
```
PUT https://api.cloudflare.com/client/v4/accounts/{account_id}/cfd_tunnel/{tunnel_id}/configurations
Body: { "config": { "ingress": [{"hostname": "{subdomain}.{domain}", "service": "http://localhost:{port}"}, {"service": "http_status:404"}] } }
```

### 涉及檔案
- `extra/paas-operator/src/services/cloudflare.py` - 擴充 CloudflareService
- `extra/paas-operator/src/api/tunnels.py` - 新檔案
- `extra/paas-operator/src/models/schemas.py` - 新增 schemas
- `extra/paas-operator/src/main.py` - 註冊 router

### 注意事項
- 建立 Tunnel 時需產生隨機 tunnel_secret（32 bytes base64）
- Tunnel Token 是 JWT 格式，包含 tunnel_id + secret，Cloudflare 產生
- DNS record 建立使用現有 `create_dns_record()` 方法

## Dependencies

- [ ] 無前置依賴，可立即開始
- [ ] 需要 Cloudflare API Token 有 Tunnel 管理權限（Account:Cloudflare Tunnel:Edit）

## Effort Estimate

- Size: S
- Hours: 6-8
- Parallel: true
