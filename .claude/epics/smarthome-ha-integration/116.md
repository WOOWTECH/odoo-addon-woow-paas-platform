---
name: OAuth 2.0 Provider
status: open
created: 2026-02-28T09:46:09Z
updated: 2026-02-28T09:53:44Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/116
depends_on: []
parallel: true
conflicts_with: []
---

# Task: OAuth 2.0 Provider

## Description

在 Odoo 中實作完整的 OAuth 2.0 Provider（RFC 6749），支援 Authorization Code Flow、Refresh Token、Client Credentials。包含 OAuth Client/Token/Authorization Code models、授權頁面、Token 端點、以及 Bearer Token 驗證 middleware。

## Acceptance Criteria

- [ ] 建立 `OAuthClient` model（client_id, client_secret, name, redirect_uris, scopes, grant_types）
- [ ] 建立 `OAuthToken` model（access_token, refresh_token, expires_at, scope, user_id, client_id）
- [ ] 建立 `OAuthCode` model（code, redirect_uri, expires_at, scope, user_id, client_id）
- [ ] `GET /oauth2/authorize` - 顯示授權頁面（需 Odoo session 登入）
- [ ] `POST /oauth2/authorize` - 使用者同意/拒絕後回傳 authorization code
- [ ] `POST /oauth2/token` - 支援 grant_type: authorization_code, refresh_token, client_credentials
- [ ] `POST /oauth2/introspect` - Token introspection（RFC 7662）
- [ ] `POST /oauth2/revoke` - Token revocation（RFC 7009）
- [ ] Authorization Code 有效期 10 分鐘
- [ ] Access Token 有效期 1 小時
- [ ] Refresh Token 有效期 30 天
- [ ] 授權頁面 QWeb template 顯示：Client 名稱、請求的 scopes、允許/拒絕按鈕
- [ ] Bearer Token 驗證 helper function（供其他 controller 使用）
- [ ] OAuth Client 可在 Odoo 後台管理（Settings 中的 OAuth Clients 選單）
- [ ] `ir.model.access.csv` 新增 OAuth 相關 model 存取規則

## Technical Details

### OAuth 2.0 Flow

```
1. HA → GET /oauth2/authorize?response_type=code&client_id=xxx&redirect_uri=xxx&scope=smarthome&state=xxx
2. Odoo 顯示授權頁面（使用者需先登入）
3. 使用者點「允許」→ POST /oauth2/authorize
4. Odoo redirect → redirect_uri?code=xxx&state=xxx
5. HA → POST /oauth2/token (grant_type=authorization_code, code=xxx, client_id=xxx, client_secret=xxx)
6. Odoo 回傳 { access_token, refresh_token, expires_in, token_type: "bearer", scope }
```

### Scopes

| Scope | 說明 |
|-------|------|
| `smarthome:read` | 讀取 Workspace、Smart Home 列表 |
| `smarthome:tunnel` | 取得 Tunnel Token |
| `workspace:read` | 讀取 Workspace 資訊 |

### Bearer Token 驗證 Helper

```python
def verify_oauth_token(request, required_scopes=None):
    """驗證 Authorization: Bearer <token> header"""
    # 1. 解析 header
    # 2. 查詢 OAuthToken
    # 3. 檢查過期
    # 4. 檢查 scope
    # 5. 回傳 user + token info
```

### 授權頁面 QWeb Template

簡潔頁面，顯示：
- Woow PaaS logo
- "應用 {client_name} 想要存取你的帳號"
- 請求的權限列表
- 「允許」「拒絕」按鈕

### 涉及檔案
- `src/models/oauth_client.py` - 新檔案
- `src/models/oauth_token.py` - 新檔案
- `src/models/oauth_code.py` - 新檔案
- `src/models/__init__.py` - import
- `src/controllers/oauth2.py` - 新檔案
- `src/controllers/__init__.py` - import
- `src/views/oauth2_templates.xml` - 授權頁面 QWeb
- `src/views/oauth_client_views.xml` - 後台管理 views
- `src/security/ir.model.access.csv` - 存取規則
- `src/__manifest__.py` - 註冊

### 安全注意
- client_secret 須 hash 儲存（不可明文）
- Authorization code 為一次性使用
- Token 使用 `secrets.token_urlsafe(32)` 產生
- PKCE (Proof Key for Code Exchange) 建議支援（HA 可能用到）
- redirect_uri 嚴格比對（防 open redirect）

## Dependencies

- [ ] 無前置依賴，可立即開始（與 Task 001、002 並行）

## Effort Estimate

- Size: L
- Hours: 16-22
- Parallel: true（與 Task 001、002 可並行）
