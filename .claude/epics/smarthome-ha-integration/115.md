---
name: Smart Home Model + Security + Odoo Controller
status: open
created: 2026-02-28T09:46:09Z
updated: 2026-02-28T09:53:44Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/115
depends_on: [114]
parallel: true
conflicts_with: []
---

# Task: Smart Home Model + Security + Odoo Controller

## Description

建立 `woow_paas_platform.smart_home` Odoo 模型，包含 Cloudflare Tunnel 資訊欄位、狀態機、安全規則。擴充 PaaS Operator Client 新增 tunnel 操作方法。建立 Smart Home CRUD controller 供 OWL 前台呼叫。

## Acceptance Criteria

- [ ] 建立 `SmartHome` model，包含所有 PRD 定義的欄位（name, workspace_id, state, tunnel_id, tunnel_token 等）
- [ ] `tunnel_token` 欄位加密儲存（不可明文查詢）
- [ ] State machine: pending → provisioning → active → error → deleting
- [ ] `create_smart_home()` 方法：建立 record → 呼叫 operator 建立 Tunnel → 更新 tunnel 資訊
- [ ] `delete_smart_home()` 方法：呼叫 operator 刪除 Tunnel → 刪除 record
- [ ] `refresh_tunnel_status()` 方法：呼叫 operator 查詢最新狀態並更新
- [ ] `ir.model.access.csv` 新增 Smart Home 存取規則
- [ ] `PaaSOperatorClient` 新增 `create_tunnel()`, `delete_tunnel()`, `get_tunnel_status()`, `get_tunnel_token()` 方法
- [ ] Smart Home controller 端點：list, create, get, delete, refresh_status
- [ ] 新增到 `__manifest__.py`

## Technical Details

### Model 結構（參照 CloudService）

```python
class SmartHome(models.Model):
    _name = 'woow_paas_platform.smart_home'
    _description = 'Smart Home Instance'

    name = fields.Char(required=True)
    workspace_id = fields.Many2one('woow_paas_platform.workspace', required=True, ondelete='cascade')
    state = fields.Selection([
        ('pending', 'Pending'),
        ('provisioning', 'Provisioning'),
        ('active', 'Active'),
        ('error', 'Error'),
        ('deleting', 'Deleting'),
    ], default='pending')
    # Tunnel fields...
    tunnel_token = fields.Char(groups='base.group_system')  # 加密存取限制
```

### Controller 端點（auth='user'）

- `POST /api/smarthome/list` - 列出 Workspace 的 Smart Homes
- `POST /api/smarthome/create` - 建立 Smart Home
- `POST /api/smarthome/get` - 取得 Smart Home 詳情
- `POST /api/smarthome/delete` - 刪除 Smart Home
- `POST /api/smarthome/refresh-status` - 重新整理 Tunnel 狀態

### 涉及檔案
- `src/models/smart_home.py` - 新檔案
- `src/models/__init__.py` - import
- `src/security/ir.model.access.csv` - 新增規則
- `src/services/paas_operator.py` - 擴充 client
- `src/controllers/smart_home.py` - 新檔案
- `src/controllers/__init__.py` - import
- `src/__manifest__.py` - 註冊

## Dependencies

- [ ] Task 001 (PaaS Operator Tunnel API) 需完成，Odoo 才能呼叫 operator 建立 Tunnel

## Effort Estimate

- Size: M
- Hours: 10-14
- Parallel: true（與 Task 003 可並行，但依賴 Task 001）
