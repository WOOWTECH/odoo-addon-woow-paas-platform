---
name: HA Integration API
status: open
created: 2026-02-28T09:46:09Z
updated: 2026-02-28T09:53:44Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/118
depends_on: [115, 116]
parallel: false
conflicts_with: []
---

# Task: HA Integration API

## Description

建立 OAuth 2.0 Bearer Token 保護的 API endpoints，供 Home Assistant Custom Component 串接。包含列出 Workspaces、列出 Smart Homes、取得 Smart Home 詳情、取得 Tunnel Token、查詢 Tunnel 狀態。

## Acceptance Criteria

- [ ] `GET /api/smarthome/workspaces` - 回傳使用者有權限的 Workspace 列表（需 scope: workspace:read）
- [ ] `GET /api/smarthome/workspaces/{id}/homes` - 回傳指定 Workspace 的 Smart Home 列表（需 scope: smarthome:read）
- [ ] `GET /api/smarthome/homes/{id}` - 回傳 Smart Home 詳情，含 Tunnel 狀態（需 scope: smarthome:read）
- [ ] `GET /api/smarthome/homes/{id}/tunnel-token` - 回傳 Tunnel Token（需 scope: smarthome:tunnel）
- [ ] `GET /api/smarthome/homes/{id}/status` - 回傳 Tunnel 即時狀態（需 scope: smarthome:read）
- [ ] 所有端點使用 OAuth Bearer Token 驗證（使用 Task 003 的 verify_oauth_token helper）
- [ ] 存取控制：使用者只能看到自己有權限的 Workspace/Smart Home
- [ ] 回傳標準 JSON 格式（非 JSON-RPC）
- [ ] 適當的 HTTP status codes（401 Unauthorized, 403 Forbidden, 404 Not Found）

## Technical Details

### Controller 結構（auth='none'，自行驗證 OAuth token）

```python
class HAApiController(http.Controller):
    @http.route('/api/smarthome/workspaces', type='http', auth='none', methods=['GET'], csrf=False)
    def list_workspaces(self, **kwargs):
        user = verify_oauth_token(request, required_scopes=['workspace:read'])
        # Return user's workspaces as JSON
```

### Response 格式

```json
// GET /api/smarthome/workspaces
{
  "workspaces": [
    { "id": 5, "name": "My Home", "slug": "my-home" }
  ]
}

// GET /api/smarthome/homes/{id}/tunnel-token
{
  "tunnel_token": "eyJhbGciOiJSUzI1NiIs...",
  "tunnel_id": "abc-123",
  "subdomain": "home-xyz.woowtech.io"
}
```

### 涉及檔案
- `src/controllers/ha_api.py` - 新檔案
- `src/controllers/__init__.py` - import

### 注意事項
- 使用 `type='http'` 而非 `type='json'`（RESTful GET endpoints）
- `auth='none'` + 自行驗證 OAuth token（不走 Odoo session）
- `csrf=False`（外部 API 不需 CSRF）
- Tunnel Token 回傳前需檢查使用者對該 Smart Home 的存取權限

## Dependencies

- [ ] Task 002 (Smart Home Model) - 需要 SmartHome model 和 workspace 關聯
- [ ] Task 003 (OAuth 2.0 Provider) - 需要 Bearer Token 驗證 helper

## Effort Estimate

- Size: S
- Hours: 4-6
- Parallel: false（需等 Task 002 + 003 完成）
