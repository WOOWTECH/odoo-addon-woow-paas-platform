---
name: Mermaid Lazy Loader 服務
status: open
created: 2026-02-26T07:11:01Z
updated: 2026-02-26T07:19:39Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/91
depends_on: []
parallel: false
conflicts_with: []
---

# Task: Mermaid Lazy Loader 服務

## Description

建立 mermaid.js lazy loading 基礎設施：下載 mermaid.min.js 並放置於不會被 asset bundle 自動載入的路徑，建立 `mermaid_loader.js` 服務提供動態載入和渲染 API。

## Acceptance Criteria

- [ ] `mermaid.min.js`（v11+）已下載並放置於 `src/static/lib/mermaid/mermaid.min.js`
- [ ] `mermaid_loader.js` 服務建立於 `src/static/src/paas/services/`
- [ ] 服務提供 `ensureLoaded()` 方法，首次呼叫時動態載入 script，後續呼叫返回快取的 Promise
- [ ] 服務提供 `renderMermaidBlocks(containerEl)` 方法，掃描容器內 `.o_woow_mermaid:not([data-processed])` 並渲染
- [ ] mermaid 初始化設定：`startOnLoad: false`、`securityLevel: 'strict'`、`theme: 'default'`
- [ ] `mermaid.min.js` 不在 `__manifest__.py` 的 asset bundle 中（路徑在 `static/lib/` 而非 `static/src/paas/`）
- [ ] 未偵測到 mermaid 內容時，完全不載入庫（Network tab 可驗證）

## Technical Details

### 檔案結構

```
src/static/lib/mermaid/
  └── mermaid.min.js          # ~2MB，從 CDN/npm 下載
src/static/src/paas/services/
  └── mermaid_loader.js       # Lazy loader 服務
```

### mermaid_loader.js 核心 API

```javascript
/** @odoo-module **/

let _loadPromise = null;

/**
 * 確保 mermaid.js 已載入並初始化。
 * 首次呼叫時動態插入 <script> 標籤，後續呼叫返回快取 Promise。
 * @returns {Promise<void>}
 */
export async function ensureLoaded() { ... }

/**
 * 掃描容器內的 .o_woow_mermaid 元素並渲染為 SVG。
 * 已渲染的元素（data-processed）會被跳過。
 * @param {HTMLElement} containerEl - 要掃描的容器
 * @returns {Promise<void>}
 */
export async function renderMermaidBlocks(containerEl) { ... }
```

### 動態載入方式

```javascript
// 使用 Odoo 靜態路徑
const scriptUrl = "/woow_paas_platform/static/lib/mermaid/mermaid.min.js";
const script = document.createElement("script");
script.src = scriptUrl;
// ... Promise 包裝 onload/onerror
```

### 渲染邏輯

```javascript
// 對每個未處理的 .o_woow_mermaid 容器：
// 1. 讀取 data-mermaid 屬性（base64 encoded content）
// 2. 呼叫 mermaid.render(uniqueId, decodedContent)
// 3. 成功：替換容器內容為 SVG
// 4. 失敗：保留原始碼，加入錯誤提示 div
// 5. 標記 data-processed="true"
```

## Dependencies

- 無前置 task 依賴
- 需要下載 mermaid.js v11+（MIT License）

## Effort Estimate

- Size: S
- Hours: 2-3
- Parallel: false（其他 task 都依賴此 task）

## Definition of Done

- [ ] mermaid.min.js 已放置於正確路徑
- [ ] mermaid_loader.js 服務可正常載入並初始化 mermaid
- [ ] 手動測試：呼叫 ensureLoaded() 後 window.mermaid 可用
- [ ] 手動測試：renderMermaidBlocks() 可將 test div 渲染為 SVG
