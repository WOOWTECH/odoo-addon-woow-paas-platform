---
name: 互動式 Mermaid 容器與樣式
status: open
created: 2026-02-26T07:11:01Z
updated: 2026-02-26T07:19:39Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/94
depends_on: [001]
parallel: true
conflicts_with: []
---

# Task: 互動式 Mermaid 容器與樣式

## Description

建立 mermaid 圖表的互動式容器，支援滑鼠滾輪縮放（zoom）、拖曳平移（pan）、雙擊重置（reset），以及全域 SCSS 樣式。將互動邏輯整合至 `mermaid_loader.js` 的渲染流程中。同時更新 `__manifest__.py` 註冊新 SCSS。

## Acceptance Criteria

- [ ] 滑鼠滾輪可縮放圖表（zoom in/out），縮放範圍 0.5x ~ 3x
- [ ] 滑鼠拖曳可平移圖表（pan），僅在按住滑鼠左鍵時生效
- [ ] 雙擊圖表重置為原始大小和位置
- [ ] 圖表容器有 toolbar（放大/縮小/重置按鈕）
- [ ] 容器有最大高度限制（400px），超出時可滾動查看
- [ ] 容器有邊框、圓角、背景色，與聊天氣泡風格一致
- [ ] Loading 狀態顯示 skeleton/spinner（在 mermaid.js 載入期間）
- [ ] 錯誤狀態顯示紅色提示框 + 原始碼
- [ ] SCSS 已在 `__manifest__.py` 中註冊（透過 `components/**/*.scss` glob 已自動載入，或放在 `styles/components/`）
- [ ] 樣式適用於所有使用 `parseMarkdown()` 的地方，不僅限 AiChat

## Technical Details

### 新增檔案

```
src/static/src/paas/styles/components/_mermaid.scss
```

### 修改檔案

```
src/static/src/paas/services/mermaid_loader.js  (Task 001 建立的檔案)
src/__manifest__.py                              (如需手動註冊 SCSS)
```

### 互動邏輯（整合至 mermaid_loader.js）

在 `renderMermaidBlocks` 成功渲染 SVG 後，為容器加入互動控制：

```javascript
function _attachInteraction(container) {
    let scale = 1;
    let translateX = 0;
    let translateY = 0;
    let isDragging = false;
    let startX, startY;

    const svgWrapper = container.querySelector(".o_woow_mermaid__svg_wrapper");

    // Zoom (滾輪)
    container.addEventListener("wheel", (e) => {
        e.preventDefault();
        const delta = e.deltaY > 0 ? -0.1 : 0.1;
        scale = Math.max(0.5, Math.min(3, scale + delta));
        _applyTransform(svgWrapper, scale, translateX, translateY);
    }, { passive: false });

    // Pan (拖曳)
    container.addEventListener("mousedown", (e) => {
        isDragging = true;
        startX = e.clientX - translateX;
        startY = e.clientY - translateY;
        container.style.cursor = "grabbing";
    });
    document.addEventListener("mousemove", (e) => { ... });
    document.addEventListener("mouseup", () => { ... });

    // Reset (雙擊)
    container.addEventListener("dblclick", () => {
        scale = 1; translateX = 0; translateY = 0;
        _applyTransform(svgWrapper, scale, translateX, translateY);
    });
}

function _applyTransform(el, scale, x, y) {
    el.style.transform = `translate(${x}px, ${y}px) scale(${scale})`;
}
```

### Toolbar HTML（渲染時注入）

```javascript
// 在 SVG 渲染成功後，注入 toolbar
const toolbar = document.createElement("div");
toolbar.className = "o_woow_mermaid__toolbar";
toolbar.innerHTML = `
    <button class="o_woow_mermaid__btn" data-action="zoom-in" title="放大">
        <span class="material-symbols-outlined">zoom_in</span>
    </button>
    <button class="o_woow_mermaid__btn" data-action="zoom-out" title="縮小">
        <span class="material-symbols-outlined">zoom_out</span>
    </button>
    <button class="o_woow_mermaid__btn" data-action="reset" title="重置">
        <span class="material-symbols-outlined">fit_screen</span>
    </button>
`;
container.prepend(toolbar);
```

### SCSS 樣式

```scss
// _mermaid.scss
.o_woow_mermaid {
    position: relative;
    border: 1px solid var(--woow-border, #e2e8f0);
    border-radius: 8px;
    background: #fafbfc;
    overflow: hidden;
    max-height: 400px;
    margin: 8px 0;

    &__svg_wrapper {
        transform-origin: 0 0;
        cursor: grab;
        &:active { cursor: grabbing; }
    }

    &__toolbar {
        position: absolute;
        top: 8px;
        right: 8px;
        display: flex;
        gap: 4px;
        z-index: 1;
        opacity: 0;
        transition: opacity 0.2s;
    }
    &:hover &__toolbar {
        opacity: 1;
    }

    &__btn {
        background: rgba(255,255,255,0.9);
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 4px;
        cursor: pointer;
        .material-symbols-outlined { font-size: 18px; }
        &:hover { background: #fff; }
    }

    // Loading 狀態
    &--loading {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100px;
        color: #999;
    }

    // 錯誤狀態
    &__error {
        background: #fff5f5;
        border: 1px solid #fc8181;
        border-radius: 4px;
        padding: 8px 12px;
        margin: 8px;
        color: #c53030;
        font-size: 13px;
    }

    // 原始碼 fallback（錯誤時顯示）
    pre {
        margin: 0;
        padding: 12px;
        font-size: 13px;
        overflow-x: auto;
    }
}
```

### __manifest__.py

確認 `src/static/src/paas/styles/components/_mermaid.scss` 是否被現有 glob 覆蓋：
- `'woow_paas_platform/static/src/paas/styles/pages/*.scss'` — 不匹配
- `'woow_paas_platform/static/src/paas/components/**/*.scss'` — 不匹配

需要手動在 `__manifest__.py` 的 `woow_paas_platform.assets_paas` 中新增：
```python
'woow_paas_platform/static/src/paas/styles/components/_mermaid.scss',
```

或者改為 glob 模式：`'woow_paas_platform/static/src/paas/styles/components/*.scss'`

## Dependencies

- [ ] Task 001 完成（mermaid_loader.js 基礎結構存在）

## Effort Estimate

- Size: M
- Hours: 3-4
- Parallel: true（可與 Task 002 並行，但需在 Task 001 之後）

## Definition of Done

- [ ] Zoom/pan/reset 互動功能正常
- [ ] Toolbar 按鈕在 hover 時出現
- [ ] 容器樣式與聊天氣泡風格一致
- [ ] Loading 和 error 狀態樣式正確
- [ ] `__manifest__.py` 已更新
- [ ] 樣式在非 AiChat 的 parseMarkdown 場景中也適用
