---
name: 錯誤處理與 Loading 狀態
status: open
created: 2026-02-26T07:11:01Z
updated: 2026-02-26T07:19:39Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/95
depends_on: [001, 002]
parallel: true
conflicts_with: []
---

# Task: 錯誤處理與 Loading 狀態

## Description

完善 mermaid 渲染的錯誤處理和 loading 狀態顯示。包含：mermaid 語法錯誤時顯示友善提示、庫載入期間顯示 loading skeleton、各種 edge case 處理（空 block、超大圖表、載入失敗等）。

## Acceptance Criteria

- [ ] mermaid 語法錯誤時：顯示原始程式碼 + 紅色錯誤提示框
- [ ] 錯誤提示為友善文字（如「圖表語法有誤，請檢查 Mermaid 語法」），不顯示 stack trace
- [ ] mermaid.js 載入期間：容器顯示 loading spinner/skeleton
- [ ] mermaid.js 載入失敗：顯示「無法載入圖表渲染引擎」提示 + 原始碼
- [ ] 空的 mermaid code block：顯示「空的圖表定義」提示
- [ ] 超大圖表（寬度超出容器）：容器自動 overflow-x 可捲動
- [ ] 所有錯誤狀態不影響頁面其他功能（不拋出未捕獲的異常）
- [ ] Console 中記錄詳細錯誤供開發者除錯

## Technical Details

### 修改檔案

```
src/static/src/paas/services/mermaid_loader.js    (強化錯誤處理)
src/static/src/paas/styles/components/_mermaid.scss (錯誤狀態樣式，如 Task 004 已建立)
```

### 渲染錯誤處理（mermaid_loader.js）

```javascript
async function _renderSingleBlock(container) {
    const encoded = container.getAttribute("data-mermaid");
    if (!encoded) {
        _showError(container, "空的圖表定義");
        return;
    }

    let content;
    try {
        content = decodeURIComponent(escape(atob(encoded)));
    } catch (e) {
        _showError(container, "圖表資料解碼失敗");
        return;
    }

    if (!content.trim()) {
        _showError(container, "空的圖表定義");
        return;
    }

    // 顯示 loading 狀態
    _showLoading(container);

    try {
        await ensureLoaded();
    } catch (loadErr) {
        console.error("Failed to load mermaid.js:", loadErr);
        _showError(container, "無法載入圖表渲染引擎，請重新整理頁面");
        _showOriginalCode(container, content);
        return;
    }

    try {
        const id = `mermaid-${Date.now()}-${Math.random().toString(36).slice(2, 7)}`;
        const { svg } = await window.mermaid.render(id, content);
        // 成功：替換為 SVG
        container.innerHTML = `<div class="o_woow_mermaid__svg_wrapper">${svg}</div>`;
        // 加入互動控制（Task 004）
    } catch (renderErr) {
        console.error("Mermaid render error:", renderErr);
        _showError(container, "圖表語法有誤，請檢查 Mermaid 語法");
        _showOriginalCode(container, content);
    } finally {
        container.setAttribute("data-processed", "true");
    }
}
```

### Helper Functions

```javascript
function _showLoading(container) {
    // 保留原始 <pre><code>，在其上方加入 loading overlay
    const loading = document.createElement("div");
    loading.className = "o_woow_mermaid--loading";
    loading.innerHTML = '<span class="o_woow_mermaid__spinner"></span> 圖表載入中...';
    container.prepend(loading);
}

function _showError(container, message) {
    const errorDiv = document.createElement("div");
    errorDiv.className = "o_woow_mermaid__error";
    errorDiv.innerHTML = `<span class="material-symbols-outlined" style="font-size:16px;vertical-align:middle">warning</span> ${message}`;
    // 在原始碼之前插入
    container.prepend(errorDiv);
}

function _showOriginalCode(container, content) {
    // 確保原始碼可見（移除 loading overlay）
    const loading = container.querySelector(".o_woow_mermaid--loading");
    if (loading) loading.remove();

    // 如果容器已被清空（如 SVG 替換後又出錯），重新加入原始碼
    if (!container.querySelector("pre")) {
        const pre = document.createElement("pre");
        const code = document.createElement("code");
        code.textContent = content;
        pre.appendChild(code);
        container.appendChild(pre);
    }
}
```

### Edge Cases

| 場景 | 處理方式 |
|------|---------|
| 空 mermaid block（` ```mermaid
``` `） | 顯示「空的圖表定義」 |
| mermaid.js 載入超時 | Promise timeout（10s），顯示載入失敗提示 |
| mermaid.js CDN/靜態路徑不存在 | script onerror 觸發，顯示載入失敗 |
| 語法錯誤（invalid mermaid） | 捕獲 render 異常，顯示友善錯誤 + 原始碼 |
| 超大圖表 | 容器 overflow-x: auto，可水平捲動 |
| 多個 mermaid block 同時渲染 | 逐個渲染（不並行，避免 mermaid.render 併發問題） |
| 同一 block 被觸發多次渲染 | data-processed 標記防止重複 |

## Dependencies

- [ ] Task 001 完成（mermaid_loader.js 基礎結構）
- [ ] Task 002 完成（parseMarkdown 輸出 mermaid 容器）
- [ ] 與 Task 004 的 SCSS 樣式協作（error/loading 樣式）

## Effort Estimate

- Size: S
- Hours: 2-3
- Parallel: true（可與 Task 003、004 並行）

## Definition of Done

- [ ] 測試無效 mermaid 語法：顯示友善錯誤 + 原始碼
- [ ] 測試空 mermaid block：顯示適當提示
- [ ] 測試 mermaid.js 載入失敗情境：顯示載入失敗提示
- [ ] 所有錯誤情境不影響頁面其他功能
- [ ] Console 中有詳細錯誤資訊
