---
name: API endpoints + AI context injection
status: open
created: 2026-02-22T06:48:56Z
updated: 2026-02-22T06:53:09Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/83
depends_on: [001]
parallel: false
conflicts_with: []
---

# Task: API endpoints + AI context injection

## Description

修改 `ai_assistant.py` controller 中所有 project 相關的 API endpoints，將 `workspace_id` 參數改為 `cloud_service_id`。同時在 `discuss_channel.py` 中注入 Cloud Service context 到 AI system prompt。

## Acceptance Criteria

- [ ] `/api/support/projects/<workspace_id>` 路由改為使用 `cloud_service_id`
- [ ] `_check_project_access()` 改為透過 `project.cloud_service_id.workspace_id` 檢查權限
- [ ] `_create_project()` 接收 `cloud_service_id` 而非 `workspace_id`
- [ ] `_list_projects()` 支援依 cloud_service_id 篩選
- [ ] `api_support_stats()` 改為透過 `cloud_service_id.workspace_id` 篩選
- [ ] AI 回答時 system prompt 包含 Cloud Service template 資訊（app name, description, category）
- [ ] AI 回答時 system prompt 包含當前 helm values 配置
- [ ] AI 回答時 system prompt 包含服務狀態（state, URL, error message）
- [ ] AI context 組裝不增加超過 100ms 延遲

## Technical Details

### 修改檔案

1. **`src/controllers/ai_assistant.py`**
   - `_check_project_access()` (line ~41-49): 改為 `project.cloud_service_id.workspace_id`
   - `_check_task_access()` (line ~51-59): 同上調整
   - 路由 `/api/support/projects/<int:workspace_id>`: 改參數名稱和邏輯
   - `_list_projects()` (line ~756-775): 改為依 cloud_service_id 或 workspace 間接篩選
   - `_create_project()` (line ~777-799): 改為設定 `cloud_service_id`
   - `_list_tasks()` (line ~860-878): 改篩選條件
   - `api_support_stats()` (line ~552-577): 改篩選邏輯

2. **`src/models/discuss_channel.py`**
   - `_post_ai_reply()` (line ~119-151): 在 system_prompt 後附加 cloud service context
   - 新增 helper method `_get_cloud_service_context(project)` 組裝 context 字串
   - Context 內容：
     ```
     ## Cloud Service Information
     - App: {template.name} ({template.category})
     - Description: {template.description}
     - Status: {service.state}
     - URL: {service.url}
     - Configuration: {helm_values as formatted text}
     - Error: {service.error_message} (if any)
     ```

### API 路由變更對照

| Before | After |
|--------|-------|
| `GET /api/support/projects/<workspace_id>` | `GET /api/support/cloud-services/<cloud_service_id>/project` |
| `POST /api/support/projects/<workspace_id>` | `POST /api/support/cloud-services/<cloud_service_id>/project` |
| `GET /api/support/tasks/<workspace_id>` | 保持不變（透過 project 間接取得） |

## Dependencies

- [ ] Task 001 完成（model 變更到位）

## Effort Estimate

- Size: M
- Hours: 5
- Parallel: false (depends on 001)

## Definition of Done

- [ ] API endpoints 正確使用 cloud_service_id
- [ ] 權限檢查透過 cloud_service.workspace_id 運作
- [ ] AI 回答包含 cloud service context
- [ ] 現有 task CRUD 功能不受影響
- [ ] Deploy 到本地 Odoo 驗證
