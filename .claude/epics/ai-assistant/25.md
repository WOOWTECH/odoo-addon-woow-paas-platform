---
name: Extend discuss.channel + AI Client + Controller
status: closed
created: 2026-02-09T16:35:07Z
updated: 2026-02-10T06:11:51Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/25
depends_on: [22]
parallel: true
conflicts_with: [24]
---

# Task: Extend discuss.channel + AI Client + Controller

## Description
使用 `_inherit` 擴展 `discuss.channel`，override `message_post()` 偵測 AI @ mention 並觸發 AI 回覆 + bus 通知。建立 `ai_client.py` OpenAI compatible HTTP client（含 streaming）。建立 `ai_assistant.py` controller 提供所有 AI 和 Support 相關 API endpoints。

## Acceptance Criteria
- [ ] `discuss_channel.py` 建立：override `message_post()` 觸發 AI 回覆 + bus notification
- [ ] `ai_client.py` 建立：OpenAI compatible HTTP client
  - [ ] `chat_completion()` 一般回覆
  - [ ] `chat_completion_stream()` SSE 串流回覆
  - [ ] Messages array 組裝（system prompt + history + user message）
- [ ] `ai_assistant.py` controller 建立，包含以下 endpoints：
  - [ ] `GET /api/ai/providers` — 列出 providers（隱藏 API Key）
  - [ ] `GET /api/ai/agents` — 列出 agents
  - [ ] `GET /api/ai/stream/<int:channel_id>` — SSE 串流端點 (type='http')
  - [ ] `POST /api/ai/chat/history` — 聊天歷史（JSON-RPC）
  - [ ] `POST /api/ai/chat/post` — 發送訊息（JSON-RPC）
  - [ ] `POST /api/ai/chat/upload` — 附件上傳（HTTP multipart）
  - [ ] `POST /api/support/projects/<int:workspace_id>` — 專案 CRUD
  - [ ] `POST /api/support/tasks/<int:workspace_id>` — 任務 CRUD
  - [ ] `POST /api/support/tasks/<int:task_id>` — 任務詳情
- [ ] `controllers/__init__.py` 更新 import
- [ ] `models/__init__.py` 更新 imports

## Technical Details
- 參考 `Woow_odoo_task_ai_solver/models/discuss_channel.py:11-25` 的 `message_post` override 模式
- 參考 `Woow_odoo_task_ai_solver/controllers/portal.py` 的聊天 API 模式
- AI Client 使用 `requests` library（Odoo 已內建）
- SSE streaming：使用 `werkzeug.Response` with `text/event-stream` content-type + generator
- `message_post` 邏輯：偵測訊息中的 `@agent_name` → 查找 agent → 用 agent 的 system_prompt + provider 呼叫 AI → 將回覆 post 回 channel
- Bus notification：`self.env['bus.bus']._sendone(channel, 'mail.message/insert', ...)`
- Controller 的 JSON-RPC endpoints 參考 `controllers/paas.py` 的 response format
- Chat history API：從 channel 的 mail.message 中查詢，附帶 attachment enrichment

### Files affected
- `src/models/discuss_channel.py` (create)
- `src/models/ai_client.py` (create)
- `src/controllers/ai_assistant.py` (create)
- `src/controllers/__init__.py` (edit)
- `src/models/__init__.py` (edit)

## Dependencies
- [ ] Task 001: 需要 ai_provider + ai_agent models 存在

## Effort Estimate
- Size: L
- Hours: 6-8
- Parallel: true (can run alongside Task 002)

## Definition of Done
- [ ] Code implemented
- [ ] discuss.channel message_post override 運作
- [ ] AI client 可成功呼叫 OpenAI compatible API
- [ ] SSE streaming endpoint 可串流回傳 AI 回覆
- [ ] 所有 controller endpoints 回傳正確格式
- [ ] Bus notification 在訊息發送時觸發
