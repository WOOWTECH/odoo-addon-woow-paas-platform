---
name: AiChat Component + @ Mention
status: open
created: 2026-02-09T16:35:07Z
updated: 2026-02-09T16:35:07Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/31
depends_on: [25]
parallel: false
conflicts_with: []
---

# Task: AiChat Component + @ Mention

## Description
建立核心 `AiChat` OWL 元件，包含訊息列表、輸入框（Enter 發送/Shift+Enter 換行）、SSE 串流即時顯示、附件上傳按鈕。建立 `AiMentionDropdown` 元件，偵測 `@` 字元觸發 agent 下拉選單。建立對應的 SCSS 樣式。

## Acceptance Criteria
- [ ] `AiChat.js` + `AiChat.xml` 建立：
  - [ ] 訊息列表：顯示 mail.message 資料（發送者名稱、頭像、時間、內容）
  - [ ] 輸入框：Enter 發送、Shift+Enter 換行
  - [ ] SSE 串流顯示：使用 EventSource API 連接 `/api/ai/stream/<channel_id>`，逐字顯示 AI 回覆
  - [ ] 附件按鈕：觸發 file input，multipart upload 到 `/api/ai/chat/upload`
  - [ ] 系統訊息顯示（如狀態變更通知）
  - [ ] Auto-scroll：新訊息自動捲到底部
  - [ ] Loading state：AI 回覆中顯示 typing indicator
- [ ] `AiMentionDropdown.js` + `AiMentionDropdown.xml` 建立：
  - [ ] 偵測輸入框中的 `@` 字元
  - [ ] 顯示可用 agent 下拉清單（從 ai_service 取得）
  - [ ] 選擇 agent 後在輸入框插入 mention tag
  - [ ] 鍵盤導航（上下鍵選擇、Enter 確認、Esc 關閉）
- [ ] `AiChat.scss` 建立：聊天介面樣式
  - [ ] 訊息氣泡（user vs assistant 不同對齊）
  - [ ] 輸入區域樣式
  - [ ] Mention dropdown 樣式
  - [ ] Typing indicator 動畫

## Technical Details
- 使用 `ai_service.js` 的方法：`fetchChatHistory()`, `postMessage()`, `getAgents()`
- SSE 串流：`new EventSource('/api/ai/stream/<channel_id>?message_id=xxx')` 監聽 AI 回覆
- 訊息格式：從 `/api/ai/chat/history` 取得 mail.message list
- @ Mention 偵測：監聽 input event，檢查游標前方是否有 `@` + 未完成的字串
- 元件接受 props：`{ channelId: Number, autoReply: Boolean }`
- 使用 `useRef` 管理 textarea 和訊息列表 DOM
- SCSS 使用 `.o_woow_` prefix，參考 `00_variables.scss` 的色彩和間距變數

### Files affected
- `src/static/src/paas/components/ai-chat/AiChat.js` (create)
- `src/static/src/paas/components/ai-chat/AiChat.xml` (create)
- `src/static/src/paas/components/ai-chat/AiChat.scss` (create)
- `src/static/src/paas/components/ai-mention/AiMentionDropdown.js` (create)
- `src/static/src/paas/components/ai-mention/AiMentionDropdown.xml` (create)

## Dependencies
- [ ] Task 003: 需要 controller API endpoints 存在（chat/history, chat/post, stream, agents）

## Effort Estimate
- Size: L
- Hours: 6-8
- Parallel: false (core component, must be solid before embedding)

## Definition of Done
- [ ] Code implemented
- [ ] 訊息列表正確顯示歷史訊息
- [ ] 發送訊息後 AI 串流回覆即時顯示
- [ ] @ 輸入觸發 agent dropdown
- [ ] 選擇 agent 後正確插入 mention
- [ ] 附件上傳功能正常
- [ ] 鍵盤快捷鍵運作（Enter/Shift+Enter）
