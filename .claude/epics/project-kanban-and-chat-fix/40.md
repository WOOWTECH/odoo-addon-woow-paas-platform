---
name: 後端 — 補齊任務序列化欄位與新增專案階段端點
status: open
created: 2026-02-10T09:14:49Z
updated: 2026-02-10T11:16:05Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/40
depends_on: []
parallel: true
conflicts_with: [43]
---

# Task：後端 — 補齊任務序列化欄位與新增專案階段端點

## 描述

修正 `_serialize_task()` 中 JSDoc 宣告與實際 API 回傳不一致的問題，並新增專案階段列表端點以支援看板視圖。

## 驗收標準

- [ ] `_serialize_task()` 回傳包含 `stage_id`、`priority`、`date_deadline`、`user_name` 欄位
- [ ] 新端點 `POST /api/support/projects/<int:project_id>/stages` 回傳該專案的階段列表 `[{id, name, sequence}]`
- [ ] 階段按 `sequence` 欄位排序
- [ ] 現有 API 呼叫端（任務列表、任務詳情）不受影響（向後相容）

## 技術細節

### 修改檔案

**`src/controllers/ai_assistant.py`**：

1. `_serialize_task()` 方法（目前在第 739-753 行）新增欄位：
   ```python
   'stage_id': task.stage_id.id if task.stage_id else None,
   'priority': task.priority or '0',
   'date_deadline': task.date_deadline.isoformat() if task.date_deadline else None,
   'user_name': task.user_ids[0].name if task.user_ids else None,
   ```

2. 新增 `_get_project_stages()` 輔助方法：
   ```python
   def _get_project_stages(self, project_id):
       stages = request.env['project.task.type'].sudo().search(
           [('project_ids', 'in', [project_id])],
           order='sequence asc',
       )
       return [{'id': s.id, 'name': s.name, 'sequence': s.sequence} for s in stages]
   ```

3. 新增端點路由：
   - `POST /api/support/projects/<int:project_id>/stages`
   - 回傳 `{'success': True, 'data': [stage_list]}`

### 注意事項
- `project.task.type` 是 Odoo 內建的任務階段模型，透過 `project_ids` many2many 關聯至專案
- 若專案無階段，回傳空陣列（前端處理備用階段邏輯）

## 依賴項

- [ ] 無前置依賴

## 工作量估計

- 大小：S
- 時數：2-3 小時
- 可平行：是（與任務 43-47 平行）

## 完成定義

- [ ] 程式碼實作完成
- [ ] API 回傳結構與 JSDoc 一致
- [ ] 手動測試驗證端點正常運作
