---
name: 前端 — AiChat 預檢驗證與錯誤碼處理
status: closed
created: 2026-02-10T09:14:49Z
updated: 2026-02-11T02:05:26Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/44
depends_on: [43]
parallel: false
conflicts_with: [45, 47]
---

# Task：前端 — AiChat 預檢驗證與錯誤碼處理

## 描述

在 `AiChat` 元件中新增 SSE 連線前的預檢驗證，並處理後端回傳的結構化 `error_code`，將通用錯誤替換為具體的使用者友善訊息。

## 驗收標準

- [ ] `startStream()` 前驗證 `channelId` 為有效正整數，否則不建立 EventSource
- [ ] `channelId` 無效時顯示「此任務尚未啟用聊天功能，請先點擊「啟用聊天」。」
- [ ] `onmessage` 中處理 `error_code` 欄位，對應至中文錯誤訊息：
  - `channel_not_found` → 「聊天頻道不存在，請重新整理頁面。」
  - `no_agent` → 「目前沒有可用的 AI 助理，請聯繫管理員設定 AI agent。」
  - `provider_not_configured` → 「AI 供應商尚未設定，請聯繫管理員。」
  - `no_message` → 「找不到訊息，請重新傳送。」
- [ ] 無 `error_code` 時仍使用原始 `error` 字串作為後備
- [ ] 移除 `onerror` 中的通用「Connection to AI was lost」訊息，改為更精確的描述

## 技術細節

### 修改檔案

**`src/static/src/paas/components/ai-chat/AiChat.js`**：

1. 新增錯誤碼映射常數：
```javascript
const ERROR_MESSAGES = {
    channel_not_found: "聊天頻道不存在，請重新整理頁面。",
    no_agent: "目前沒有可用的 AI 助理，請聯繫管理員設定 AI agent。",
    provider_not_configured: "AI 供應商尚未設定，請聯繫管理員。",
    no_message: "找不到訊息，請重新傳送。",
};
```

2. 修改 `startStream()` 新增預檢：
```javascript
startStream() {
    if (!this.props.channelId || typeof this.props.channelId !== 'number') {
        this.state.error = "此任務尚未啟用聊天功能，請先點擊「啟用聊天」。";
        return;
    }
    // ... 原有邏輯
}
```

3. 修改 `onmessage` 中的錯誤處理：
```javascript
if (data.error) {
    this.state.error = ERROR_MESSAGES[data.error_code] || data.error;
    this.closeStream();
    return;
}
```

4. 修改 `onerror` 的錯誤訊息：
```javascript
this.state.error = "與 AI 的連線中斷，正在嘗試重新連線...";
// （任務 45 會在此加入自動重連邏輯）
```

## 依賴項

- [ ] 任務 43 完成（後端需先回傳 `error_code`）

## 工作量估計

- 大小：S
- 時數：2-3 小時
- 可平行：否（依賴任務 43，且與 45/47 修改同一檔案）

## 完成定義

- [ ] 預檢驗證 channelId 正常運作
- [ ] 各 error_code 顯示對應中文訊息
- [ ] 手動測試：未設定 provider 時顯示正確錯誤而非「Connection lost」
