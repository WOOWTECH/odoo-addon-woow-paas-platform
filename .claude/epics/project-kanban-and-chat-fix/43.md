---
name: 後端 — 修正 SSE 端點錯誤處理
status: open
created: 2026-02-10T09:14:49Z
updated: 2026-02-10T11:16:05Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/43
depends_on: []
parallel: true
conflicts_with: [40]
---

# Task：後端 — 修正 SSE 端點錯誤處理

## 描述

修正 `api_ai_stream()` 端點的根本 bug：當前端使用 `EventSource` 時，非 200 的 HTTP 狀態碼會觸發 `onerror`，導致結構化錯誤訊息無法被前端接收。修改為永遠回傳 HTTP 200，將錯誤作為 SSE data 事件發送。

## 驗收標準

- [ ] SSE 端點所有回傳均為 HTTP 200（包括錯誤情況）
- [ ] 錯誤回傳包含 `error_code` 欄位以供前端區分
- [ ] 支援以下錯誤碼：
  - `channel_not_found` — channel 不存在
  - `no_agent` — 無可用 AI agent
  - `provider_not_configured` — AI provider 未設定或未啟用
  - `no_message` — 找不到使用者訊息
- [ ] 每個錯誤回傳格式：`data: {"error": "描述", "error_code": "碼", "done": true}\n\n`
- [ ] 正常串流行為不受影響

## 技術細節

### 修改檔案

**`src/controllers/ai_assistant.py`** 的 `api_ai_stream()` 方法（第 275-389 行）：

修改前（以 channel not found 為例）：
```python
return Response(
    'data: {"error": "Channel not found"}\n\n',
    content_type='text/event-stream',
    status=404,  # ← 問題：EventSource 無法讀取非 200 回應的 body
)
```

修改後：
```python
return Response(
    'data: ' + json.dumps({
        'error': 'Channel not found',
        'error_code': 'channel_not_found',
        'done': True,
    }) + '\n\n',
    content_type='text/event-stream',
    headers={
        'Cache-Control': 'no-cache',
        'Connection': 'keep-alive',
        'X-Accel-Buffering': 'no',
    },
    status=200,  # ← 修正：永遠 200
)
```

需修改的錯誤回傳共 4 處：
1. 第 290-294 行：channel 不存在 → `channel_not_found`
2. 第 298-303 行：無 agent → `no_agent`
3. 第 306-311 行：provider 未設定 → `provider_not_configured`
4. 第 321-326 行：無使用者訊息 → `no_message`

### 注意事項
- 所有錯誤回傳都需要加上 SSE 標準 headers（`Cache-Control`、`Connection`、`X-Accel-Buffering`）
- `done: true` 確保前端在收到錯誤後關閉 EventSource
- 此任務修改 `ai_assistant.py` 與任務 40 有衝突，需協調（建議先完成 40 再做 43，或合併提交）

## 依賴項

- [ ] 無前置依賴（但與任務 40 修改同一檔案，需注意衝突）

## 工作量估計

- 大小：S
- 時數：1-2 小時
- 可平行：是（與任務 41-46 平行，但注意與 40 的檔案衝突）

## 完成定義

- [ ] 所有 SSE 錯誤回傳改為 HTTP 200
- [ ] 每個錯誤含有 `error_code` 欄位
- [ ] 手動測試：未設定 provider 時，前端 `onmessage` 能收到錯誤（而非 `onerror`）
