---
name: 前端 — AiChat 連線狀態指示器 UI
status: closed
created: 2026-02-10T09:14:49Z
updated: 2026-02-11T02:05:26Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/47
depends_on: [45]
parallel: false
conflicts_with: [44, 45]
---

# Task：前端 — AiChat 連線狀態指示器 UI

## 描述

在 `AiChat` 元件的聊天區域頂部新增連線狀態指示器，讓使用者可以即時了解 AI 聊天的連線狀態。

## 驗收標準

- [ ] 新增 `connectionState` 狀態欄位，值為：`idle`、`connecting`、`connected`、`streaming`、`error`、`reconnecting`
- [ ] 聊天區域頂部顯示連線狀態指示器（小圓點 + 文字）
- [ ] 狀態視覺對應：
  - `idle` — 灰色圓點，「待命中」
  - `connecting` — 黃色圓點（閃爍動畫），「連線中...」
  - `connected` — 綠色圓點，「已連線」（2 秒後自動隱藏）
  - `streaming` — 綠色圓點（脈動動畫），「AI 回覆中...」
  - `error` — 紅色圓點，顯示錯誤訊息
  - `reconnecting` — 黃色圓點（閃爍動畫），「重新連線中...（第 N 次）」
- [ ] `connected` 狀態 2 秒後自動隱藏指示器（減少視覺干擾）
- [ ] 錯誤狀態顯示時提供「重試」按鈕

## 技術細節

### 修改檔案

**`src/static/src/paas/components/ai-chat/AiChat.js`**：

1. `state` 新增：
```javascript
connectionState: "idle", // idle | connecting | connected | streaming | error | reconnecting
```

2. 在各生命週期點更新狀態：
- `startStream()` 開始 → `connecting`
- `onmessage` 第一個 chunk → `streaming`
- `onmessage` done → `connected`（然後 2 秒後回 `idle`）
- `onerror` → `error` 或 `reconnecting`
- `closeStream()` → 根據上下文設定

3. 新增方法：
```javascript
get connectionIndicator() {
    const map = {
        idle: { color: "gray", text: "待命中", visible: false },
        connecting: { color: "yellow", text: "連線中...", visible: true, animate: "blink" },
        connected: { color: "green", text: "已連線", visible: true },
        streaming: { color: "green", text: "AI 回覆中...", visible: true, animate: "pulse" },
        error: { color: "red", text: this.state.error, visible: true },
        reconnecting: { color: "yellow", text: this.state.error, visible: true, animate: "blink" },
    };
    return map[this.state.connectionState] || map.idle;
}

onRetryClick() {
    this._reconnectAttempts = 0;
    this.state.connectionState = "connecting";
    this.startStream();
}
```

**`src/static/src/paas/components/ai-chat/AiChat.xml`**：

在訊息列表上方新增指示器：
```xml
<div t-if="connectionIndicator.visible"
     t-attf-class="o_woow_chat__status o_woow_chat__status--#{connectionIndicator.color}">
    <span class="o_woow_chat__status_dot"
          t-attf-class="o_woow_chat__status_dot--#{connectionIndicator.animate or ''}"/>
    <span class="o_woow_chat__status_text" t-esc="connectionIndicator.text"/>
    <button t-if="state.connectionState === 'error'"
            class="o_woow_chat__retry_btn"
            t-on-click="onRetryClick">重試</button>
</div>
```

**`src/static/src/paas/styles/pages/_ai_chat_page.scss`**（或新增至現有聊天樣式）：
```scss
.o_woow_chat__status {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    font-size: 12px;

    &--green .o_woow_chat__status_dot { background: #22c55e; }
    &--yellow .o_woow_chat__status_dot { background: #f59e0b; }
    &--red .o_woow_chat__status_dot { background: #ef4444; }
    &--gray .o_woow_chat__status_dot { background: #9ca3af; }
}

.o_woow_chat__status_dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;

    &--blink { animation: blink 1s infinite; }
    &--pulse { animation: pulse 1.5s infinite; }
}
```

## 依賴項

- [ ] 任務 45 完成（自動重連邏輯需先到位）

## 工作量估計

- 大小：M
- 時數：2-3 小時
- 可平行：否（依賴任務 45，修改同一檔案）

## 完成定義

- [ ] 連線狀態指示器正確顯示各狀態
- [ ] 動畫效果正常（閃爍、脈動）
- [ ] `connected` 狀態 2 秒後自動隱藏
- [ ] 錯誤狀態的「重試」按鈕正常運作
- [ ] 視覺風格與現有聊天 UI 一致
