---
name: 前端 — 實作看板拖曳階段更新
status: closed
created: 2026-02-10T09:14:49Z
updated: 2026-02-11T02:05:26Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/42
depends_on: [41]
parallel: false
conflicts_with: []
---

# Task：前端 — 實作看板拖曳階段更新

## 描述

在 `ProjectKanbanPage` 上實作 HTML5 原生拖曳功能，讓使用者可以將任務卡片從一個階段欄拖至另一個階段欄，自動更新任務的 `stage_id`。

## 驗收標準

- [ ] 任務卡片可拖曳（`draggable="true"`）
- [ ] 拖曳時卡片顯示半透明效果（`dragstart` 設定 opacity）
- [ ] 拖曳至目標欄位時有視覺高亮提示（`dragover` 加上 CSS class）
- [ ] 放下卡片時樂觀式更新 UI（立即移動卡片至新欄位）
- [ ] 放下後呼叫 `supportService.updateTask(taskId, { stage_id: newStageId })` 更新後端
- [ ] API 失敗時回滾卡片至原始欄位，並顯示錯誤 toast
- [ ] 拖曳至相同欄位時不觸發 API 呼叫

## 技術細節

### 修改檔案

**`src/static/src/paas/pages/project-kanban/ProjectKanbanPage.js`**：

新增拖曳相關方法：
```javascript
onDragStart(ev, task) {
    ev.dataTransfer.setData("text/plain", JSON.stringify({
        taskId: task.id,
        fromStageId: task.stage_id,
    }));
    ev.dataTransfer.effectAllowed = "move";
    // 設定拖曳中的視覺效果
}

onDragOver(ev) {
    ev.preventDefault();
    ev.dataTransfer.dropEffect = "move";
    // 加上 drop zone 高亮 class
}

onDragLeave(ev) {
    // 移除 drop zone 高亮 class
}

async onDrop(ev, targetStageId) {
    ev.preventDefault();
    const data = JSON.parse(ev.dataTransfer.getData("text/plain"));
    if (data.fromStageId === targetStageId) return;

    // 樂觀式 UI 更新
    this._moveTask(data.taskId, targetStageId);

    // 呼叫 API
    const result = await supportService.updateTask(data.taskId, { stage_id: targetStageId });
    if (!result.success) {
        // 回滾
        this._moveTask(data.taskId, data.fromStageId);
        // 顯示錯誤
    }
}
```

**`src/static/src/paas/pages/project-kanban/ProjectKanbanPage.xml`**：
- 卡片加上 `draggable="true"` `t-on-dragstart="(ev) => this.onDragStart(ev, task)"`
- 欄位加上 `t-on-dragover="onDragOver"` `t-on-dragleave="onDragLeave"` `t-on-drop="(ev) => this.onDrop(ev, stage.id)"`

**`src/static/src/paas/styles/pages/_project_kanban.scss`**：
- `.o_woow_kanban__column--dragover` 高亮樣式（虛線邊框 + 背景色）
- `.o_woow_kanban__card--dragging` 半透明樣式

### 注意事項
- 使用現有的 `supportService.updateTask()` 方法，不需新增 API
- `_moveTask()` 為內部方法，操作 `this.state.tasks` 陣列以實現樂觀式更新

## 依賴項

- [ ] 任務 41 完成（看板元件需先建立）

## 工作量估計

- 大小：M
- 時數：3-4 小時
- 可平行：否（依賴任務 41）

## 完成定義

- [ ] 拖曳功能實作完成
- [ ] 樂觀式 UI 更新 + 失敗回滾正常運作
- [ ] 拖曳視覺回饋（半透明、高亮）正確顯示
- [ ] 手動測試通過：拖曳卡片至不同欄位，重新整理後確認階段已更新
