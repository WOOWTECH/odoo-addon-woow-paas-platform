---
name: 前端 — AiChat 指數退避自動重連
status: closed
created: 2026-02-10T09:14:49Z
updated: 2026-02-11T02:05:26Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/45
depends_on: [44]
parallel: false
conflicts_with: [44, 47]
---

# Task：前端 — AiChat 指數退避自動重連

## 描述

在 `AiChat` 元件的 `onerror` 處理器中實作自動重連機制，使用指數退避策略（1s → 2s → 4s），最多重試 3 次。

## 驗收標準

- [ ] SSE 連線中斷時（`onerror` 觸發），自動重試連線
- [ ] 重試間隔為指數退避：第 1 次 1 秒、第 2 次 2 秒、第 3 次 4 秒
- [ ] 最多重試 3 次，超過後顯示最終錯誤訊息
- [ ] 重試期間顯示「正在重新連線...（第 N 次嘗試）」
- [ ] 若重連成功，重置重試計數器
- [ ] 若收到結構化錯誤（`error_code`），不觸發重連（屬於業務錯誤，非網路問題）
- [ ] 元件卸載時清除重連計時器

## 技術細節

### 修改檔案

**`src/static/src/paas/components/ai-chat/AiChat.js`**：

1. `setup()` 中新增狀態：
```javascript
this._reconnectAttempts = 0;
this._reconnectTimer = null;
this._maxReconnectAttempts = 3;
```

2. 新增重連方法：
```javascript
_scheduleReconnect() {
    if (this._reconnectAttempts >= this._maxReconnectAttempts) {
        this.state.error = "無法連線至 AI 服務，請稍後再試或重新整理頁面。";
        return;
    }
    const delay = Math.pow(2, this._reconnectAttempts) * 1000; // 1s, 2s, 4s
    this._reconnectAttempts++;
    this.state.error = `正在重新連線...（第 ${this._reconnectAttempts} 次嘗試）`;

    this._reconnectTimer = setTimeout(() => {
        this.startStream();
    }, delay);
}

_clearReconnectTimer() {
    if (this._reconnectTimer) {
        clearTimeout(this._reconnectTimer);
        this._reconnectTimer = null;
    }
}
```

3. 修改 `onerror` 處理器（區分業務錯誤與網路錯誤）：
```javascript
this.eventSource.onerror = () => {
    const hadContent = !!this.state.streamingText;
    const partialText = this.state.streamingText;
    this.closeStream();

    if (hadContent) {
        // 有部分回應，保存並停止
        this.state.messages.push({...partialMessage});
        this._reconnectAttempts = 0;
    } else {
        // 無回應，嘗試重連
        this._scheduleReconnect();
    }
};
```

4. `onmessage` 成功收到 chunk 時重置計數器：
```javascript
if (data.chunk) {
    this._reconnectAttempts = 0; // 連線正常，重置
    this.state.streamingText += data.chunk;
}
```

5. `onWillUnmount` 清除計時器：
```javascript
onWillUnmount(() => {
    this.closeStream();
    this._clearReconnectTimer();
});
```

6. `closeStream()` 也清除計時器：
```javascript
closeStream() {
    this._clearReconnectTimer();
    // ... 原有邏輯
}
```

## 依賴項

- [ ] 任務 44 完成（預檢與錯誤碼處理需先到位）

## 工作量估計

- 大小：M
- 時數：2-3 小時
- 可平行：否（依賴任務 44，修改同一檔案）

## 完成定義

- [ ] 自動重連機制實作完成
- [ ] 指數退避正確（1s、2s、4s）
- [ ] 超過 3 次顯示最終錯誤
- [ ] 元件卸載時無殘留計時器
- [ ] 手動測試：斷開 port-forward 後觀察重連行為
