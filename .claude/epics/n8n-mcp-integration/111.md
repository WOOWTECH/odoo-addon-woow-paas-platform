---
name: Add MCP sidecar health check and sync retry mechanism
status: open
created: 2026-02-27T14:18:57Z
updated: 2026-02-27T14:31:13Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/111
depends_on: [004]
parallel: false
conflicts_with: []
---

# Task: Add MCP sidecar health check and sync retry mechanism

## Description
MCP sidecar 啟動需要時間，初次 `action_sync_tools()` 可能因 sidecar 尚未就緒而失敗。新增重試機制和健康檢查，確保 tool discovery 最終成功。

## Acceptance Criteria
- [ ] `action_sync_tools()` 失敗時自動重試（最多 3 次，間隔 10 秒）
- [ ] 重試邏輯僅對 auto_created MCP Server 生效（手動建立的不自動重試）
- [ ] 重試期間 MCP Server state 為 `draft`（非 error），避免誤導使用者
- [ ] 全部重試失敗後，state 為 `error`，`state_message` 記錄失敗原因
- [ ] Cloud Service 設定頁面可手動觸發重新同步（已有 _sync_mcp_server API）
- [ ] 可選：利用 Odoo ir.cron 或 queue_job 進行異步重試

## Technical Details
- 修改 `src/models/mcp_server.py` 的 `_async_sync_tools()` 方法
- 重試邏輯：
  ```python
  async def _async_sync_tools_with_retry(self, max_retries=3, delay=10):
      for attempt in range(max_retries):
          try:
              await self._async_sync_tools()
              return  # 成功
          except Exception as e:
              if attempt < max_retries - 1:
                  await asyncio.sleep(delay)
              else:
                  raise  # 最後一次失敗，拋出異常
  ```
- 或使用 Odoo 的 `ir.cron` 建立定時任務檢查 auto_created + state=draft 的 MCP Server
- 考慮在 `_auto_create_mcp_servers()` 中使用 `threading.Timer` 延遲首次 sync

## Dependencies
- [ ] Task 004: 自動建立 MCP Server hook 已實作

## Effort Estimate
- Size: S
- Hours: 3
- Parallel: false

## Definition of Done
- [ ] Sidecar 啟動慢時仍能最終成功同步 tools
- [ ] 全部重試失敗有明確錯誤狀態
- [ ] 不影響非 auto_created MCP Server 的行為
