---
name: Inject MCP sidecar config into Helm values during deployment
status: open
created: 2026-02-27T14:18:57Z
updated: 2026-02-27T14:31:13Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/107
depends_on: [001, 002]
parallel: false
conflicts_with: [004]
---

# Task: Inject MCP sidecar config into Helm values during deployment

## Description
修改 `_create_service()` 方法，在 Helm values 合併後、install_release 調用前，根據模板的 MCP 設定注入 sidecar container 配置到 Helm values 中。同時處理 n8n API Key 的自動生成。

## Acceptance Criteria
- [ ] 當 `template.mcp_enabled=True` 時，自動注入 sidecar 配置到 merged_values
- [ ] 生成 UUID v4 格式的 API Key
- [ ] API Key 透過 Helm values 傳遞（存入 K8s Secret 由 chart template 處理）
- [ ] API Key 同時記錄到 service 的 helm_values 中（供後續 MCP Server 建立使用）
- [ ] 當 `template.mcp_enabled=False` 時不注入任何內容
- [ ] Sidecar 資源限制合理（256Mi memory, 200m CPU）

## Technical Details
- 修改 `src/controllers/paas.py` 的 `_create_service()` 方法（約 line 1279 之後）
- 注入邏輯：
  1. 檢查 `template.mcp_enabled`
  2. 生成 API Key（`uuid.uuid4()`）
  3. 構建 sidecar env（合併 template.mcp_sidecar_env + 動態值如 API Key）
  4. 注入 `extraContainers`（或 Task 001 驗證後的替代 key）到 merged_values
- Sidecar container spec 包含：
  - name, image, ports, env, resources
  - livenessProbe, readinessProbe（基於 Task 001 驗證的 health endpoint）
- 注入的 values key 取決於 Task 001 的驗證結果（extraContainers / sidecars / 其他）
- API Key 生成邏輯應為獨立 helper method，方便測試

## Dependencies
- [ ] Task 001: 確認 Helm chart 支援的 sidecar values key
- [ ] Task 002: CloudAppTemplate MCP 欄位已就位

## Effort Estimate
- Size: M
- Hours: 6
- Parallel: false

## Definition of Done
- [ ] 部署 n8n 時 Helm values 包含 sidecar 配置
- [ ] API Key 自動生成且格式正確
- [ ] 非 MCP 模板的部署不受影響
- [ ] Unit test 覆蓋值注入邏輯
