---
name: Auto-create MCP Server record on deployment completion
status: open
created: 2026-02-27T14:18:57Z
updated: 2026-02-27T14:31:13Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/109
depends_on: [002, 003]
parallel: false
conflicts_with: [003]
---

# Task: Auto-create MCP Server record on deployment completion

## Description
在 Cloud Service 狀態從 deploying 轉為 running 時，自動建立 user-scope MCP Server 記錄並觸發 tool discovery。這是整個自動配置流程的核心 hook。

## Acceptance Criteria
- [ ] `_update_service_status()` 中，當 state 轉為 `running` 且 `template.mcp_enabled=True` 時，自動建立 MCP Server
- [ ] MCP Server 記錄包含正確的：
  - `name`: "{service.name} MCP"
  - `url`: 基於 subdomain + sidecar port + endpoint path 構建
  - `transport`: 來自 template.mcp_transport
  - `scope`: 'user'
  - `cloud_service_id`: service.id
  - `auto_created`: True
- [ ] 建立後自動觸發 `action_sync_tools()`（異步，不阻塞狀態更新）
- [ ] 如果 MCP Server 已存在（重複部署/升級），不重複建立
- [ ] Sync tools 失敗時 MCP Server state 為 'error'，不影響 Cloud Service state

## Technical Details
- 修改 `src/controllers/paas.py` 的 `_update_service_status()` 方法（約 line 1572-1655）
- Hook 位置：在 `service.write({'state': 'running', ...})` 之後
- MCP endpoint URL 構建：
  - 如使用 Ingress path routing: `https://{subdomain}.{domain}{mcp_endpoint_path}`
  - 如使用 K8s internal: `http://{helm_release_name}-mcp.{namespace}.svc.cluster.local:{port}{path}`
  - 需根據 Task 001 驗證結果決定
- 防重複建立：先查詢 `mcp_server.search([('cloud_service_id', '=', service.id), ('auto_created', '=', True)])`
- Tool sync 重試：初次 sync 可能因 sidecar 尚未就緒而失敗，考慮延遲 5-10 秒後重試

## Dependencies
- [ ] Task 002: McpServer auto_created 欄位
- [ ] Task 003: Sidecar 配置已注入，API Key 已生成

## Effort Estimate
- Size: M
- Hours: 5
- Parallel: false

## Definition of Done
- [ ] 部署完成後 MCP Server 記錄自動建立
- [ ] Tool discovery 成功執行
- [ ] 重複部署不產生重複記錄
- [ ] 異常處理覆蓋各種失敗場景
