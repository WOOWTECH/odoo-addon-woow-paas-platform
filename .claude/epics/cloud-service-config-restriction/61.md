---
name: "Backend: Reject unauthorized helm value keys"
status: closed
created: 2026-02-14T16:16:38Z
updated: 2026-02-14T17:03:47Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/61
depends_on: [001]
parallel: false
conflicts_with: [001]
---

# Task: Backend — Reject unauthorized helm value keys

## Description

修改 `_filter_allowed_helm_values` 從「靜默丟棄非法 key」改為「回傳非法 key 資訊」，並在 `_update_service` 中檢查非法 key 時回傳明確 error。

## Acceptance Criteria

- [ ] 傳送含非法 key 的 update 請求回傳 `{'success': False, 'error': 'Unauthorized configuration keys: ...'}`
- [ ] Error message 包含被拒絕的 key 名稱
- [ ] 只含合法 key 的請求正常處理（不受影響）
- [ ] 無 `helm_value_specs` 的 template 維持允許全部 key（向下相容）
- [ ] `_create_service` 也套用相同的拒絕邏輯

## Technical Details

**檔案**: `src/controllers/paas.py`

**修改 `_filter_allowed_helm_values`**（:952）：

改變回傳方式，新增 rejected keys 回報：

```python
def _filter_allowed_helm_values(self, values, template):
    # ... existing spec parsing logic ...

    filtered = {}
    rejected = []
    for key, value in values.items():
        if key in allowed_keys:
            filtered[key] = value
        else:
            rejected.append(key)

    return filtered, rejected
```

**修改 `_update_service`**（:1183）和 `_create_service`：

```python
filtered_user_values, rejected_keys = self._filter_allowed_helm_values(values, service.template_id)
if rejected_keys:
    return {'success': False, 'error': f'Unauthorized configuration keys: {", ".join(rejected_keys)}'}
```

## Dependencies

- [ ] 001 完成（同檔案，避免衝突）

## Effort Estimate

- Size: S
- Hours: 1
- Parallel: false

## Definition of Done

- [ ] `_filter_allowed_helm_values` 回傳 rejected keys
- [ ] `_update_service` 拒絕非法 key 並回傳 error
- [ ] `_create_service` 也套用拒絕邏輯
- [ ] 無 spec template 向下相容
