---
name: "Frontend: ConfigurationTab edit mode with HelmValueForm"
status: closed
created: 2026-02-14T16:16:38Z
updated: 2026-02-14T17:03:47Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/63
depends_on: [001, 003]
parallel: false
conflicts_with: [003]
---

# Task: Frontend — ConfigurationTab edit mode with HelmValueForm

## Description

將 ConfigurationTab 的編輯模式從 raw JSON textarea 替換為 `HelmValueForm` 結構化表單元件，複用 AppConfigurationPage 已驗證的表單邏輯。

## Acceptance Criteria

- [ ] 點擊 "Edit Configuration" 顯示 `HelmValueForm` 表單（非 textarea）
- [ ] 表單欄位來自 `service.template.helm_value_specs`
- [ ] Required 欄位有值驗證（不可為空）
- [ ] Optional 欄位在 "Advanced Settings" 折疊區
- [ ] 欄位初始值從 `service.helm_values` 中提取
- [ ] 儲存時只傳送 spec 定義的 key/value 給 `cloudService.updateService`
- [ ] 儲存成功後退出編輯模式並更新顯示
- [ ] 取消時恢復原值

## Technical Details

**檔案**: `ConfigurationTab.js` + `ConfigurationTab.xml`

**JS 修改**：

Import 新增：
```javascript
import { HelmValueForm } from "../../../components/config/HelmValueForm";
```

Static components 新增 `HelmValueForm`。

移除：`editedValuesJson` getter, `onValuesChange`, JSON parse/stringify 邏輯

新增/修改：
```javascript
setup() {
    this.state = useState({
        editing: false,
        saving: false,
        error: null,
        editedValues: {},      // Object (非 JSON string)
        showAdvanced: false,
        errors: {},            // 驗證 errors
    });
}

startEditing() {
    // 從 helm_values 提取 spec key 的值
    const values = {};
    for (const spec of this.allSpecs) {
        values[spec.key] = this.getSpecValue(spec);
    }
    this.state.editedValues = values;
    this.state.editing = true;
    this.state.error = null;
}

onHelmValueUpdate(key, value) {
    this.state.editedValues = { ...this.state.editedValues, [key]: value };
    // Clear field error
    if (this.state.errors[key]) {
        const newErrors = { ...this.state.errors };
        delete newErrors[key];
        this.state.errors = newErrors;
    }
}

toggleAdvanced() {
    this.state.showAdvanced = !this.state.showAdvanced;
}

validateForm() {
    const errors = {};
    for (const spec of (this.helmValueSpecs.required || [])) {
        const value = this.state.editedValues[spec.key];
        if (value === undefined || value === null || value === '') {
            errors[spec.key] = `${spec.label} is required`;
        }
    }
    this.state.errors = errors;
    return Object.keys(errors).length === 0;
}

async saveChanges() {
    if (!this.validateForm()) return;

    this.state.saving = true;
    this.state.error = null;

    const result = await cloudService.updateService(
        this.props.workspaceId,
        this.props.service.id,
        this.state.editedValues
    );

    if (result.success) {
        this.state.editing = false;
        this.state.editedValues = {};
        if (this.props.onSave) {
            this.props.onSave(this.state.editedValues);
        }
    } else {
        this.state.error = result.error || "Failed to update configuration";
    }
    this.state.saving = false;
}
```

**XML 修改**（編輯區塊）：

用 `<HelmValueForm>` 取代 `<textarea>`：
```xml
<HelmValueForm
    specs="helmValueSpecs"
    values="state.editedValues"
    onUpdate.bind="onHelmValueUpdate"
    showAdvanced="state.showAdvanced"
    errors="state.errors"
/>
```

加入 Advanced toggle（參考 AppConfigurationPage.xml 的實作）。

移除 `hasChanges` 和 JSON 相關的 UI 元素。

## Dependencies

- [ ] 001（API 回傳 helm_value_specs）
- [ ] 003（唯讀模式 refactor，同檔案避免衝突）

## Effort Estimate

- Size: M
- Hours: 1.5
- Parallel: false

## Definition of Done

- [ ] HelmValueForm 取代 textarea
- [ ] Required 欄位驗證正常
- [ ] Advanced settings toggle 正常
- [ ] 儲存成功觸發 service upgrade
- [ ] 取消恢復原值
