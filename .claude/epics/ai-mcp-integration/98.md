---
name: Frontend AiChat tool call visualization
status: closed
created: 2026-02-26T16:12:18Z
updated: 2026-02-26T16:22:04Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/98
depends_on: [103]
parallel: false
conflicts_with: []
---

# Task: Frontend AiChat tool call visualization

## Description

修改 AiChat OWL component，解析 SSE 中新的 `tool_call` 和 `tool_result` event types，並以折疊式 UI 顯示 tool 調用過程。包含 loading 狀態（正在調用工具）和錯誤狀態。

## Acceptance Criteria

- [ ] AiChat SSE parser 支援 `type: "tool_call"` 和 `type: "tool_result"` events
- [ ] Tool call 在訊息中以折疊式 block 顯示（預設折疊）
- [ ] 折疊式 block 顯示：tool icon + tool name + "Used tool" 標籤
- [ ] 展開後顯示：tool name、input args（formatted JSON）、result
- [ ] 串流中 tool call 階段顯示 loading indicator（"Calling {tool_name}..."）
- [ ] 多個 tool calls 按順序顯示
- [ ] Tool call 後的 text response 正常串流顯示
- [ ] 沒有 tool calls 時行為完全不變（向後相容）

## Technical Details

### 修改檔案
- `src/static/src/paas/components/ai-chat/AiChat.js` — SSE parser + rendering logic
- `src/static/src/paas/components/ai-chat/AiChat.xml` — Template for tool call blocks
- `src/static/src/paas/styles/components/_tool_call.scss` — Tool call block styles
- 更新 `src/__manifest__.py`（如有新 SCSS）

### SSE Parser 修改

```javascript
// AiChat.js - onSSEMessage handler
onSSEMessage(event) {
    const data = JSON.parse(event.data);

    switch (data.type) {
        case "chunk":
            // 現有邏輯：append to current message
            this.appendChunk(data.content);
            break;
        case "tool_call":
            // 新增：顯示 tool call block（loading 狀態）
            this.addToolCall(data.tool, data.args);
            break;
        case "tool_result":
            // 新增：更新 tool call block（result 狀態）
            this.updateToolResult(data.tool, data.result);
            break;
        case "done":
            // 現有邏輯：finalize message
            this.finalizeMessage(data.message_id);
            break;
    }
}
```

### Tool Call Block UI（XML template）

```xml
<t t-foreach="message.toolCalls" t-as="tc" t-key="tc.id">
    <div class="o_woow_tool_call" t-att-class="{ 'is-loading': !tc.result }">
        <div class="o_woow_tool_call__header" t-on-click="() => this.toggleToolCall(tc.id)">
            <span class="material-symbols-outlined">build</span>
            <span class="o_woow_tool_call__name" t-esc="tc.tool"/>
            <span class="o_woow_tool_call__badge">Used tool</span>
            <span class="material-symbols-outlined o_woow_tool_call__chevron">
                <t t-if="tc.expanded">expand_less</t>
                <t t-else="">expand_more</t>
            </span>
        </div>
        <div t-if="tc.expanded" class="o_woow_tool_call__body">
            <div class="o_woow_tool_call__section">
                <label>Input</label>
                <pre t-esc="JSON.stringify(tc.args, null, 2)"/>
            </div>
            <div t-if="tc.result" class="o_woow_tool_call__section">
                <label>Result</label>
                <pre t-esc="tc.result"/>
            </div>
            <div t-if="!tc.result" class="o_woow_tool_call__loading">
                <span class="spinner"/>
                Calling tool...
            </div>
        </div>
    </div>
</t>
```

### SCSS 樣式

```scss
.o_woow_tool_call {
    margin: 8px 0;
    border: 1px solid var(--woow-border);
    border-radius: 8px;
    overflow: hidden;

    &__header {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        cursor: pointer;
        background: var(--woow-surface-alt);
    }

    &__badge {
        font-size: 11px;
        padding: 2px 6px;
        border-radius: 4px;
        background: var(--woow-primary-light);
        color: var(--woow-primary);
    }

    &__body {
        padding: 12px;
        pre { font-size: 12px; white-space: pre-wrap; }
    }

    &.is-loading .o_woow_tool_call__header {
        opacity: 0.7;
    }
}
```

## Dependencies

- [ ] Task #103 完成（SSE controller 發送 tool_call/tool_result events）

## Effort Estimate

- Size: M
- Hours: 6-8
- Parallel: false（依賴 Task #103 的 SSE 格式）

## Definition of Done

- [ ] Tool call 在 AI 訊息中正確顯示折疊式 block
- [ ] Loading 狀態正常顯示
- [ ] 展開/折疊互動正常
- [ ] 多個 tool calls 按順序顯示
- [ ] 無 tool calls 時行為不變
- [ ] 樣式與現有設計系統一致
