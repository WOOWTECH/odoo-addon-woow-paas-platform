---
name: SSE controller tool call events + discuss_channel integration
status: closed
created: 2026-02-26T16:12:18Z
updated: 2026-02-26T16:22:04Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/103
depends_on: [99, 101]
parallel: false
conflicts_with: []
---

# Task: SSE controller tool call events + discuss_channel integration

## Description

修改 SSE streaming controller 和 discuss_channel.py，整合 tool calling。SSE generator 需要解析 `ai_client` 的新 event types（`tool_call`, `tool_result`, `text_chunk`）並轉發給前端。discuss_channel 的非 SSE 路徑也需支援 tool calling。

## Acceptance Criteria

- [ ] SSE endpoint `/api/ai/stream/<channel_id>` 在回覆前取得 assistant 的 enabled MCP tools
- [ ] 同時合併 cloud service 的 user MCP tools（如果有）
- [ ] SSE generator 呼叫 `chat_completion_stream_with_tools()` 並正確轉發三種 event types
- [ ] SSE event 格式：
  - Text: `data: {"type": "chunk", "content": "...", "done": false}

`
  - Tool call: `data: {"type": "tool_call", "tool": "name", "args": {...}}

`
  - Tool result: `data: {"type": "tool_result", "tool": "name", "result": "..."}

`
  - Done: `data: {"type": "done", "message_id": N}

`
- [ ] `discuss_channel.py` 的 `message_post` AI reply 路徑使用 `chat_completion_with_tools()`
- [ ] Tool call metadata 存入 message（可選：JSON field 或 body 中的 hidden data）
- [ ] MCP 連線失敗時 graceful fallback（降級為純文字對話 + 錯誤訊息）

## Technical Details

### 修改檔案
- `src/controllers/ai_assistant.py` — SSE generator 修改
- `src/models/discuss_channel.py` — AI reply 路徑修改

### SSE Controller 修改

```python
# ai_assistant.py - SSE generator 內
# 之前：
for chunk in client.chat_completion_stream(messages):
    yield f'data: {{"chunk": "{chunk}", "done": false}}

'

# 之後：
mcp_tools = assistant.get_enabled_mcp_tools()
# 合併 cloud service user tools（如果 task 有 cloud_service_id）
if cloud_service and cloud_service.user_mcp_server_ids:
    user_tools = cloud_service.user_mcp_server_ids.mapped('tool_ids').filtered('active')
    mcp_tools |= user_tools

for event in client.chat_completion_stream_with_tools(messages, mcp_tools):
    if event["type"] == "text_chunk":
        escaped = json.dumps(event["content"])[1:-1]
        yield f'data: {{"type": "chunk", "content": "{escaped}", "done": false}}

'
    elif event["type"] == "tool_call":
        yield f'data: {json.dumps({"type": "tool_call", "tool": event["tool"], "args": event["args"]})}

'
    elif event["type"] == "tool_result":
        yield f'data: {json.dumps({"type": "tool_result", "tool": event["tool"], "result": event["result"]})}

'
```

### discuss_channel.py 修改

```python
# 在 AI reply 路徑中
mcp_tools = assistant.get_enabled_mcp_tools()
if cloud_service:
    user_tools = cloud_service.user_mcp_server_ids.mapped('tool_ids').filtered('active')
    mcp_tools |= user_tools

response = client.chat_completion_with_tools(messages, mcp_tools)
```

### Graceful Fallback

```python
try:
    for event in client.chat_completion_stream_with_tools(messages, mcp_tools):
        ...
except Exception as e:
    _logger.warning(f"MCP tool calling failed, falling back to text-only: {e}")
    for chunk in client.chat_completion_stream(messages):
        yield f'data: {{"type": "chunk", "content": "{chunk}", "done": false}}

'
```

## Dependencies

- [ ] Task #99 完成（`get_enabled_mcp_tools()` 存在）
- [ ] Task #101 完成（`chat_completion_stream_with_tools()` 存在）

## Effort Estimate

- Size: M
- Hours: 6-8
- Parallel: false（依賴 Task #101）

## Definition of Done

- [ ] SSE 串流正確包含 tool_call 和 tool_result events
- [ ] discuss_channel AI reply 支援 tool calling
- [ ] MCP 連線失敗時 graceful fallback
- [ ] 可用 curl 驗證 SSE event 格式
