---
name: AI Assistant MCP Server relation + form view
status: open
created: 2026-02-26T16:12:18Z
updated: 2026-02-26T16:22:04Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/99
depends_on: [97]
parallel: false
conflicts_with: []
---

# Task: AI Assistant MCP Server relation + form view

## Description

擴充 `ai.assistant` model，新增 MCP Server Many2many 關聯和 tool 黑名單欄位。在 AI Assistant form view 中加入 MCP 設定區塊，讓 admin 可為每個 assistant 選擇可用的 MCP servers 並停用個別 tools。

## Acceptance Criteria

- [ ] `ai.assistant` 新增 `mcp_server_ids` (Many2many → `mcp_server`, domain: scope=system)
- [ ] `ai.assistant` 新增 `mcp_tool_disabled_ids` (Many2many → `mcp_tool`)
- [ ] `ai.assistant` 新增 `get_enabled_mcp_tools()` method，回傳過濾後的 `mcp_tool` recordset
- [ ] AI Assistant form view 新增 "MCP Servers" notebook page
- [ ] Page 中有 MCP Server 勾選清單（帶 server state 顯示）
- [ ] 選中 server 後展開其 tools 列表，可個別 disable
- [ ] `get_enabled_mcp_tools()` 正確計算：所有啟用 server 的 active tools − disabled_ids

## Technical Details

### 修改檔案
- `src/models/ai_assistant.py` — 擴充（可能是新建，inherit `ai.assistant`）
- `src/views/ai_assistant_views.xml` — 新建或擴充 form view
- 更新 `src/models/__init__.py`
- 更新 `src/__manifest__.py`

### Model 擴充

```python
class AiAssistant(models.Model):
    _inherit = 'ai.assistant'

    mcp_server_ids = fields.Many2many(
        'woow_paas_platform.mcp_server',
        string='MCP Servers',
        domain=[('scope', '=', 'system'), ('state', '=', 'connected')],
    )
    mcp_tool_disabled_ids = fields.Many2many(
        'woow_paas_platform.mcp_tool',
        string='Disabled MCP Tools',
    )

    def get_enabled_mcp_tools(self):
        """Return mcp_tool records that are enabled for this assistant."""
        all_tools = self.mcp_server_ids.mapped('tool_ids').filtered('active')
        return all_tools - self.mcp_tool_disabled_ids
```

### View 結構

在 `ai.assistant` form view 中用 `inherit_id` 新增 notebook page：

```xml
<xpath expr="//notebook" position="inside">
    <page string="MCP Servers">
        <field name="mcp_server_ids" widget="many2many_checkboxes"/>
        <field name="mcp_tool_disabled_ids" widget="many2many_tags"/>
    </page>
</xpath>
```

## Dependencies

- [ ] Task #97 完成（MCP Server + Tool models 存在）

## Effort Estimate

- Size: S
- Hours: 3-4
- Parallel: false（依賴 Task #97）

## Definition of Done

- [ ] AI Assistant form view 顯示 MCP Servers 設定區
- [ ] 可勾選/取消勾選 MCP servers
- [ ] 可停用個別 tools
- [ ] `get_enabled_mcp_tools()` 回傳正確結果
