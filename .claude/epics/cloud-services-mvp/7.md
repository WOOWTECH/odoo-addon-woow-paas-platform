---
name: Odoo API & Operator Client
status: closed
created: 2026-02-01T17:23:19Z
updated: 2026-02-02T00:00:00Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/7
depends_on: [5, 6]
parallel: false
conflicts_with: []
---

# Task: Odoo API & Operator Client

## Description

建立 Odoo 端的 Cloud Service JSON API 和 PaaS Operator HTTP client，實現 Odoo 與 PaaS Operator 之間的通訊。

## Acceptance Criteria

- [x] PaaS Operator HTTP client 實現（Python requests wrapper）
- [x] Cloud Service JSON API endpoints 實現：
  - [x] GET `/woow/api/cloud/templates` - 取得應用模板列表
  - [x] GET `/woow/api/cloud/templates/{id}` - 取得單一模板
  - [x] GET `/woow/api/workspaces/{id}/services` - 取得服務列表
  - [x] POST `/woow/api/workspaces/{id}/services` - 建立服務
  - [x] GET `/woow/api/workspaces/{id}/services/{service_id}` - 取得服務詳情
  - [x] PATCH `/woow/api/workspaces/{id}/services/{service_id}` - 更新服務
  - [x] DELETE `/woow/api/workspaces/{id}/services/{service_id}` - 刪除服務
  - [x] POST `/woow/api/workspaces/{id}/services/{service_id}/rollback` - 回滾
  - [x] GET `/woow/api/workspaces/{id}/services/{service_id}/revisions` - 版本歷史
- [x] 部署流程整合（Odoo → Operator → 狀態輪詢）
- [x] 錯誤處理與狀態同步

## Technical Details

### PaaS Operator Client (`src/services/paas_operator.py`)

```python
class PaaSOperatorClient:
    def __init__(self, base_url, api_key):
        self.base_url = base_url
        self.headers = {'X-API-Key': api_key}

    def create_namespace(self, namespace, quota):
        """POST /api/namespaces"""
        pass

    def install_release(self, namespace, release_name, chart, values):
        """POST /api/releases"""
        pass

    def get_release(self, namespace, release_name):
        """GET /api/releases/{namespace}/{name}"""
        pass

    def upgrade_release(self, namespace, release_name, values):
        """PATCH /api/releases/{namespace}/{name}"""
        pass

    def uninstall_release(self, namespace, release_name):
        """DELETE /api/releases/{namespace}/{name}"""
        pass

    def rollback_release(self, namespace, release_name, revision):
        """POST /api/releases/{namespace}/{name}/rollback"""
        pass

    def get_revisions(self, namespace, release_name):
        """GET /api/releases/{namespace}/{name}/revisions"""
        pass

    def get_status(self, namespace, release_name):
        """GET /api/releases/{namespace}/{name}/status"""
        pass
```

### Controller Endpoints (`src/controllers/paas.py`)

擴展現有的 paas.py，加入 Cloud Service 相關 API：

```python
@http.route('/woow/api/cloud/templates', type='json', auth='user')
def api_cloud_templates(self, category=None, search=None, **kw):
    """Get application templates"""
    pass

@http.route('/woow/api/workspaces/<int:workspace_id>/services', type='json', auth='user', methods=['GET', 'POST'])
def api_workspace_services(self, workspace_id, **kw):
    """List or create services"""
    pass

@http.route('/woow/api/workspaces/<int:workspace_id>/services/<int:service_id>', type='json', auth='user', methods=['GET', 'PATCH', 'DELETE'])
def api_workspace_service(self, workspace_id, service_id, **kw):
    """Get, update, or delete a service"""
    pass
```

### 部署流程

1. 用戶點擊 Launch
2. Odoo 建立 CloudService record (state=pending)
3. Odoo 呼叫 Operator: POST /api/namespaces (if needed)
4. Odoo 呼叫 Operator: POST /api/releases
5. Odoo 輪詢 Operator: GET /api/releases/.../status
6. 當 Ready，更新 CloudService (state=running)

### 設定
- PaaS Operator URL: `ir.config_parameter` (woow_paas_platform.operator_url)
- PaaS Operator API Key: `ir.config_parameter` (woow_paas_platform.operator_api_key)

### Files to Create/Modify
- `src/services/__init__.py` (新建目錄)
- `src/services/paas_operator.py` (新建)
- `src/controllers/paas.py` (修改 - 加入 API)
- `src/models/res_config_settings.py` (修改 - 加入設定欄位)

## Dependencies

- [ ] Task 001: PaaS Operator Service 完成
- [ ] Task 002: Odoo Models 完成

## Effort Estimate

- Size: M
- Hours: 8-12
- Parallel: false (depends on 001 and 002)

## Definition of Done

- [x] Operator client 可成功與 PaaS Operator 通訊
- [x] 所有 API endpoints 可正常回應
- [x] 部署流程可正常執行（從 pending 到 running）
- [x] 錯誤處理正確（state=error + error_message）
- [x] 設定可透過 Odoo Settings 頁面配置
