---
name: PaaS Operator Service
status: closed
created: 2026-02-01T17:23:19Z
updated: 2026-02-01T17:55:25Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/5
depends_on: []
parallel: false
conflicts_with: []
---

# Task: PaaS Operator Service

## Description

建立獨立的 PaaS Operator 服務（FastAPI），負責執行所有 Helm 操作。此服務部署於 K8s cluster 內，透過 API Key 認證接收來自 Odoo 的請求。

**Location**: `extra/paas-operator/`

## Acceptance Criteria

- [ ] FastAPI 專案結構建立完成
- [ ] Helm CLI wrapper 實現（subprocess 調用）
- [ ] API endpoints 實現：
  - [ ] POST `/api/releases` - helm install
  - [ ] GET `/api/releases/{namespace}/{name}` - get release
  - [ ] PATCH `/api/releases/{namespace}/{name}` - helm upgrade
  - [ ] DELETE `/api/releases/{namespace}/{name}` - helm uninstall
  - [ ] POST `/api/releases/{namespace}/{name}/rollback` - helm rollback
  - [ ] GET `/api/releases/{namespace}/{name}/revisions` - helm history
  - [ ] GET `/api/releases/{namespace}/{name}/status` - pod status
  - [ ] POST `/api/namespaces` - create namespace with quota
- [ ] API Key 認證 middleware
- [ ] Health check endpoint (`/health`)
- [ ] Dockerfile 建立
- [ ] K8s manifests: Deployment, Service (ClusterIP), RBAC, Secret
- [ ] README 包含部署說明

## Technical Details

### 目錄結構
```
extra/paas-operator/
├── src/
│   ├── main.py           # FastAPI app entry
│   ├── config.py         # Settings (API Key, etc.)
│   ├── api/
│   │   ├── __init__.py
│   │   ├── releases.py   # Helm release endpoints
│   │   └── namespaces.py # Namespace management
│   ├── services/
│   │   ├── __init__.py
│   │   └── helm.py       # Helm CLI wrapper
│   └── models/
│       ├── __init__.py
│       └── schemas.py    # Pydantic models
├── tests/
│   ├── test_releases.py
│   └── test_helm.py
├── Dockerfile
├── requirements.txt
├── k8s/
│   ├── deployment.yaml
│   ├── service.yaml
│   ├── rbac.yaml
│   └── secret.yaml
└── README.md
```

### Helm Wrapper 實現
- 使用 `subprocess.run()` 調用 Helm CLI
- 設定 `KUBECONFIG` 或使用 in-cluster config
- 解析 Helm 輸出為結構化資料
- 錯誤處理與日誌記錄

### RBAC 權限
```yaml
rules:
  - apiGroups: [""]
    resources: ["namespaces", "secrets", "configmaps", "services", "persistentvolumeclaims"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: ["apps"]
    resources: ["deployments", "statefulsets"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
  - apiGroups: ["networking.k8s.io"]
    resources: ["ingresses"]
    verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
```

### 安全限制
- 只能操作 `paas-ws-*` namespace（在 RBAC 或程式碼中限制）
- API Key 透過 Secret 注入

## Dependencies

- [ ] K3s cluster 可用
- [ ] Helm CLI 可執行

## Effort Estimate

- Size: L
- Hours: 16-24
- Parallel: false (foundation task)

## Definition of Done

- [ ] 所有 API endpoints 實現並可正常運作
- [ ] pytest 單元測試覆蓋 > 80%
- [ ] Dockerfile 可成功 build image
- [ ] K8s manifests 可成功部署到 cluster
- [ ] README 包含完整部署說明
- [ ] API 文檔 (OpenAPI/Swagger) 可存取
