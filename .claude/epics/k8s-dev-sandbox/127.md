---
name: 建立/銷毀腳本 (create + destroy)
status: open
created: 2026-02-28T09:46:14Z
updated: 2026-02-28T09:54:37Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/127
depends_on: [002]
parallel: false
conflicts_with: []
---

# Task: 建立/銷毀腳本 (create + destroy)

## Description

建立 `scripts/k8s-sandbox-create.sh` 和 `scripts/k8s-sandbox-destroy.sh`，這是整個 skill 的核心操作腳本。Create 腳本偵測 branch、計算 namespace、呼叫 helm install、等待 Pod ready、執行 Odoo 初始化。Destroy 腳本清理整個 namespace。

## Acceptance Criteria

- [ ] `k8s-sandbox-create.sh` 自動偵測當前 git branch 並生成 slug
- [ ] 支援 `--branch`、`--ttl`、`--image` 參數覆蓋
- [ ] 自動計算 namespace 名稱（`dev-sandbox-{slug}`）
- [ ] 呼叫 `helm install` 部署完整 chart
- [ ] 等待所有 Pod ready（timeout 5 分鐘）
- [ ] 首次建立時自動初始化 Odoo（安裝 module、載入語言包）
- [ ] 完成後顯示存取資訊（URL、admin 帳密）
- [ ] `k8s-sandbox-destroy.sh` 呼叫 `helm uninstall` + 刪除 namespace
- [ ] Destroy 支援 `--force` 跳過確認
- [ ] 前置檢查：kubectl 和 helm 是否可用

## Technical Details

**Branch slug 邏輯**（沿用 `setup-worktree-env.sh`）:
```bash
BRANCH=$(git rev-parse --abbrev-ref HEAD)
SLUG=$(echo "$BRANCH" | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//')
NAMESPACE="dev-sandbox-${SLUG}"
```

**Odoo 初始化**:
```bash
kubectl exec -n $NAMESPACE deploy/odoo -- odoo \
  -d $DB_NAME \
  -i base,woow_paas_platform \
  --stop-after-init \
  --without-demo=all \
  --load-language=zh_TW
```

**TTL annotation**:
```bash
kubectl annotate namespace $NAMESPACE \
  sandbox.woow.tw/ttl="${TTL}" \
  sandbox.woow.tw/created="$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
  sandbox.woow.tw/expires="$(date -u -d "+${TTL}" +%Y-%m-%dT%H:%M:%SZ)"
```

## Dependencies

- [ ] Task 002（核心服務模板，chart 需可部署）

## Effort Estimate

- Size: L
- Hours: 6-8
- Parallel: false（此為 critical path）

## Definition of Done

- [ ] Create 腳本可在 K3s 上成功建立沙盒
- [ ] Odoo 可透過 port-forward 或 Ingress 存取
- [ ] Destroy 腳本完全清理所有資源
- [ ] 錯誤處理完善（kubectl/helm 不存在、cluster 不可達等）
