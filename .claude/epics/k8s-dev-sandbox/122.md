---
name: TTL 自動清理管理
status: open
created: 2026-02-28T09:46:14Z
updated: 2026-02-28T09:54:37Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/122
depends_on: [004]
parallel: true
conflicts_with: []
---

# Task: TTL 自動清理管理

## Description

實現沙盒的 TTL 自動清理機制，透過 K8s CronJob 定期檢查 namespace annotation 上的到期時間，並自動刪除過期的沙盒。同時提供 `k8s-sandbox-extend.sh` 讓開發者手動延長 TTL。

## Acceptance Criteria

- [ ] `ttl-cronjob.yaml` Helm 模板：CronJob 每小時執行一次，檢查並清理過期沙盒
- [ ] CronJob 使用的 cleanup 腳本以 ConfigMap 掛載
- [ ] CronJob 具備 RBAC 權限刪除 namespace 和 helm release
- [ ] `k8s-sandbox-extend.sh <name> [--ttl <duration>]` 更新到期時間
- [ ] `--ttl 0` 設定永不過期
- [ ] TTL 到期前 1 天在 CronJob log 中輸出警告
- [ ] 部署在 `paas-system` namespace（全域 CronJob，不在沙盒 namespace 內）

## Technical Details

**CronJob 邏輯**:
```bash
# 列出所有 dev-sandbox-* namespace
for ns in $(kubectl get ns -l sandbox.woow.tw/managed=true -o name); do
  expires=$(kubectl get $ns -o jsonpath='{.metadata.annotations.sandbox\.woow\.tw/expires}')
  if [ "$expires" != "never" ] && [ "$(date -u +%s)" -gt "$(date -d "$expires" +%s)" ]; then
    # 過期，清理
    helm uninstall -n $ns $(helm list -n $ns -q)
    kubectl delete $ns
  fi
done
```

**Extend 腳本**:
```bash
NEW_EXPIRES=$(date -u -d "+${TTL}" +%Y-%m-%dT%H:%M:%SZ)
kubectl annotate namespace $NAMESPACE \
  sandbox.woow.tw/expires="$NEW_EXPIRES" --overwrite
```

**RBAC**: CronJob 需要 ClusterRole 權限刪除 namespace 和管理 helm release。

## Dependencies

- [ ] Task 004（create 腳本，需要沙盒存在來測試 TTL）

## Effort Estimate

- Size: M
- Hours: 4-6
- Parallel: true（可與 Task 005, 007 並行）

## Definition of Done

- [ ] CronJob 模板完成並通過 `helm template` 驗證
- [ ] 手動設定短 TTL 後 CronJob 能正確清理
- [ ] Extend 腳本可正確更新到期時間
- [ ] RBAC 最小權限原則
