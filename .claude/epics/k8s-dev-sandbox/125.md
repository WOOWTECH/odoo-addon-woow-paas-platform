---
name: 網路層模板 (Nginx + Ingress + NetworkPolicy)
status: open
created: 2026-02-28T09:46:14Z
updated: 2026-02-28T09:54:37Z
github: https://github.com/WOOWTECH/odoo-addon-woow-paas-platform/issues/125
depends_on: [001]
parallel: true
conflicts_with: [002]
---

# Task: 網路層模板 (Nginx + Ingress + NetworkPolicy)

## Description

建立 Nginx 反向代理、Ingress、NetworkPolicy 的 Helm 模板。Nginx 處理 WebSocket 和靜態資源，Ingress 提供外部存取，NetworkPolicy 確保 namespace 隔離。

## Acceptance Criteria

- [ ] Nginx Deployment + Service 模板完成
- [ ] Nginx ConfigMap 包含反向代理配置（proxy_pass to Odoo, WebSocket 支援）
- [ ] Ingress 模板支援自動 hostname 生成（`{branch-slug}.dev.woow.tw`）
- [ ] Ingress 可透過 values 完全停用（本地開發可能不需要）
- [ ] NetworkPolicy 限制 namespace 之間的流量（僅允許 Ingress 進入）
- [ ] PgAdmin Deployment（optional，由 `pgadmin.enabled` 控制）

## Technical Details

**Nginx ConfigMap**:
- 參考現有 Docker Compose 的 nginx 配置
- 處理 `/websocket` → Odoo 8072 port
- 處理 `/` → Odoo 8069 port
- 靜態資源快取頭

**Ingress**:
- 使用 `{{ .Values.ingress.className }}`（K3s 預設 traefik）
- hostname: `{{ .Values.sandbox.branch }}.{{ .Values.ingress.domain }}`
- 可停用（`ingress.enabled: false`）

**NetworkPolicy**:
- Default deny all ingress
- Allow from Ingress controller namespace
- Allow internal communication within namespace
- Allow DNS (kube-system)

**PgAdmin** (optional):
- `{{ if .Values.pgadmin.enabled }}`
- 暴露在 NodePort 或透過 Ingress 子路徑

## Dependencies

- [ ] Task 001（Chart 基礎結構）

## Effort Estimate

- Size: M
- Hours: 4-6
- Parallel: true（可與 Task 002 並行）

## Definition of Done

- [ ] Nginx 模板完成
- [ ] Ingress 模板完成
- [ ] NetworkPolicy 模板完成
- [ ] PgAdmin optional 模板完成
- [ ] `helm template` 通過驗證
