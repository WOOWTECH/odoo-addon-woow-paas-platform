<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="sh_ai_assistance.AiChatMainTemplate">
        <div class="h-100 d-flex flex-column">
            <!-- Loading State -->
            <t t-if="state.isLoading">
                <div class="d-flex align-items-center justify-content-center h-100">
                    <div class="text-center">
                        <i class="fa fa-spinner fa-spin fa-2x mb-3 text-primary"/>
                        <div class="text-muted">Loading session...</div>
                    </div>
                </div>
            </t>

            <!-- Error State -->
            <t t-elif="hasError">
                <div class="d-flex align-items-center justify-content-center h-100">
                    <div class="text-center">
                        <i class="fa fa-exclamation-triangle fa-2x mb-3 text-warning"/>
                        <div class="text-muted">
                            <t t-esc="state.error"/>
                        </div>
                    </div>
                </div>
            </t>

            <!-- Empty State (No Session Selected) -->
            <t t-elif="isEmptyState">
                <div class="d-flex align-items-center justify-content-center h-100">
                    <div class="text-center">
                        <div class="mb-4">
                            <i class="fa fa-comments fa-4x text-primary opacity-50"/>
                        </div>
                        <h3 class="text-muted mb-3">Welcome to AI Chat</h3>
                        <p class="text-muted mb-4">
                            Select an existing conversation from the sidebar<br/>
                            or start a new conversation to begin.
                        </p>
                        <div class="d-flex align-items-center justify-content-center text-muted">
                            <i class="fa fa-arrow-left me-2"/>
                            <span>Click "New Conversation" to get started</span>
                        </div>
                    </div>
                </div>
            </t>

            <!-- Active Session -->
            <t t-elif="hasSession">
                <!-- Minimalistic Session Header -->
                <div class="ai-chat-header">
                    <div class="header-content">
                        <div class="session-info">
                            <!-- Editable Session Name -->
                            <t t-if="!state.isEditingName">
                                <div class="session-title-group">
                                    <h6 class="session-title"
                                        t-on-click="startEditingName"
                                        title="Click to edit">
                                        <t t-esc="state.currentSession.name"/>
                                    </h6>
                                    <button class="edit-btn"
                                            title="Rename Session"
                                            t-on-click="startEditingName">
                                        <i class="fa fa-pencil"/>
                                    </button>
                                </div>
                            </t>

                            <t t-if="state.isEditingName">
                                <div class="session-edit-group">
                                    <input type="text"
                                           class="session-edit-input"
                                           t-model="state.editingName"
                                           t-on-keydown="onNameInputKeydown"/>
                                    <div class="edit-actions">
                                        <button class="save-btn"
                                                t-on-click="saveSessionName"
                                                title="Save">
                                            <i class="fa fa-check"/>
                                        </button>
                                        <button class="cancel-btn"
                                                t-on-click="cancelEditingName"
                                                title="Cancel">
                                            <i class="fa fa-times"/>
                                        </button>
                                    </div>
                                </div>
                            </t>

                            <div class="message-count">
                                <t t-esc="state.currentSession.message_count"/> messages
                            </div>
                        </div>

                        <!-- Minimalistic Model Selector -->
                        <div class="model-selector">
                            <button class="share-btn btn btn-outline-primary"
                                t-on-click="onShareSession"
                                title="Share Session">
                               Share
                            </button>
                            <button class="export-btn btn btn-outline-secondary"
                                t-on-click="onExportChat"
                                title="Export Chat">
                               <i class="fa fa-upload me-1"/>Export Chat
                            </button>

                            
                            <div class="dropdown">

                                <button class="model-selector-btn"
                                        type="button"
                                        data-bs-toggle="dropdown"
                                        aria-expanded="false"
                                        t-att-disabled="state.isProcessing"
                                        t-att-class="state.isProcessing ? 'disabled' : ''"
                                        title="Select AI Model">
                                    <div class="selected-model-avatar">
                                        <t t-if="state.selectedModel and state.selectedModel.image">
                                            <img class="selected-model-avatar-img"
                                                 t-att-src="'/web/image/sh.ai.llm/' + state.selectedModel.id + '/image'"
                                                 t-att-alt="state.selectedModel.name"/>
                                        </t>
                                        <t t-else="">
                                            <div class="selected-model-avatar-default">
                                                <i class="fa fa-robot"/>
                                            </div>
                                        </t>
                                    </div>
                                    <span class="model-name">
                                        <span t-if="state.selectedModel" t-esc="state.selectedModel.name"/>
                                        <span t-else="">Select Model</span>
                                    </span>
                                    <i class="fa fa-chevron-down"/>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end model-dropdown">
                                    <t t-foreach="state.availableModels" t-as="model" t-key="model.id">
                                        <li>
                                            <button class="model-dropdown-item"
                                                    t-att-class="(model.id === state.selectedModel?.id ? 'active' : '') + (state.isProcessing ? ' disabled' : '')"
                                                    t-att-disabled="state.isProcessing"
                                                    t-on-click="() => this.selectModel(model)">
                                                <div class="model-avatar">
                                                    <t t-if="model.image">
                                                        <img class="model-avatar-img"
                                                             t-att-src="'/web/image/sh.ai.llm/' + model.id + '/image'"
                                                             t-att-alt="model.name"/>
                                                    </t>
                                                    <t t-else="">
                                                        <div class="model-avatar-default">
                                                            <i class="fa fa-robot"/>
                                                        </div>
                                                    </t>
                                                </div>
                                                <div class="model-info">
                                                    <div class="model-name-main">
                                                        <t t-esc="model.name"/>
                                                    </div>
                                                    <div class="model-company">
                                                        <t t-esc="model.sh_company"/>
                                                    </div>
                                                </div>
                                                <i t-if="model.id === state.selectedModel?.id" class="fa fa-check model-check"/>
                                            </button>
                                        </li>
                                    </t>
                                    <t t-if="state.availableModels.length === 0">
                                        <li><span class="model-dropdown-item disabled">No models configured</span></li>
                                    </t>

                                    <t t-if="state.isProcessing">
                                        <li><span class="model-dropdown-item disabled text-muted small">Model selection disabled during AI processing...</span></li>
                                    </t>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Content -->
                <AiChatContent
                    sessionId="state.currentSession.id"
                    sessionToken="props.sessionToken"
                    selectedModel="state.selectedModel"
                    availableModels="state.availableModels"
                    currentLlmCompany="props.currentLlmCompany"
                    processingSessions="props.processingSessions"
                    onSessionRenamed="props.onSessionRenamed"
                    onMessageSent.bind="onMessageSent"
                    onSetSessionProcessing="props.onSetSessionProcessing"/>
            </t>
        </div>
    </t>
</templates>