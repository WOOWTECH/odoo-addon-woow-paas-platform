<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="woow_paas_platform.ProjectKanbanPage">
        <div class="o_woow_kanban__page">
            <!-- Page Header -->
            <div class="o_woow_kanban__page_header">
                <div class="o_woow_kanban__page_header_left">
                    <button class="o_woow_kanban__back_btn" t-on-click="navigateBack">
                        <WoowIcon name="'arrow_back'" size="20"/>
                    </button>
                    <div class="o_woow_kanban__page_header_text">
                        <h1 t-esc="projectName"/>
                        <p><t t-esc="taskCount"/> tasks</p>
                    </div>
                </div>
                <div class="o_woow_kanban__page_header_right">
                    <button class="o_woow_kanban__create_btn" t-on-click="() => this.openCreateModal()">
                        <WoowIcon name="'add'" size="20"/>
                        <span>Create Task</span>
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <t t-if="loading">
                <div class="o_woow_kanban__loading">
                    <div class="o_woow_kanban__loading_dots">
                        <span class="o_woow_kanban__loading_dot"/>
                        <span class="o_woow_kanban__loading_dot"/>
                        <span class="o_woow_kanban__loading_dot"/>
                    </div>
                    <p>Loading kanban board...</p>
                </div>
            </t>

            <!-- Error State -->
            <t t-elif="error">
                <div class="o_woow_kanban__error">
                    <WoowIcon name="'error'" size="48"/>
                    <p t-esc="error"/>
                    <button class="o_woow_kanban__retry_btn" t-on-click="_loadData">Retry</button>
                </div>
            </t>

            <!-- Kanban Board -->
            <t t-elif="columns.length > 0">
                <div class="o_woow_kanban">
                    <t t-foreach="columns" t-as="column" t-key="column.stage.id">
                        <div class="o_woow_kanban__column"
                             t-on-dragover="onDragOver"
                             t-on-dragleave="onDragLeave"
                             t-on-drop="(ev) => this.onDrop(ev, column.stage.id)">
                            <!-- Column Header -->
                            <div class="o_woow_kanban__column_header">
                                <span class="o_woow_kanban__column_name" t-esc="column.stage.name"/>
                                <span class="o_woow_kanban__column_count" t-esc="column.tasks.length"/>
                                <button class="o_woow_kanban__column_add_btn"
                                        t-on-click="(ev) => { ev.stopPropagation(); this.openCreateModal(column.stage.id); }">
                                    <WoowIcon name="'add'" size="16"/>
                                </button>
                            </div>

                            <!-- Task Cards -->
                            <div class="o_woow_kanban__column_body">
                                <t t-if="column.tasks.length > 0">
                                    <t t-foreach="column.tasks" t-as="task" t-key="task.id">
                                        <div class="o_woow_kanban__card"
                                             draggable="true"
                                             t-on-click="() => this.navigateToTask(task.id)"
                                             t-on-dragstart="(ev) => this.onDragStart(ev, task)"
                                             t-on-dragend="onDragEnd">
                                            <div class="o_woow_kanban__card_title" t-esc="task.name"/>

                                            <t t-if="hasPriority(task)">
                                                <span class="o_woow_kanban__card_priority" t-esc="getPriorityStars(task)"/>
                                            </t>

                                            <div class="o_woow_kanban__card_meta">
                                                <t t-if="task.user_name">
                                                    <span class="o_woow_kanban__card_user">
                                                        <WoowIcon name="'person'" size="14"/>
                                                        <t t-esc="task.user_name"/>
                                                    </span>
                                                </t>
                                                <t t-if="task.date_deadline">
                                                    <span t-att-class="'o_woow_kanban__card_deadline ' + getDeadlineClass(task.date_deadline)">
                                                        <WoowIcon name="'schedule'" size="14"/>
                                                        <t t-esc="formatDeadline(task.date_deadline)"/>
                                                    </span>
                                                </t>
                                            </div>
                                        </div>
                                    </t>
                                </t>
                                <t t-else="">
                                    <div class="o_woow_kanban__column_empty">
                                        <span>No tasks in this stage</span>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </t>
                </div>
            </t>

            <!-- Empty Board (no stages) -->
            <t t-else="">
                <div class="o_woow_kanban__empty">
                    <WoowIcon name="'view_kanban'" size="48"/>
                    <p>No tasks yet. Create your first task to get started!</p>
                    <button class="o_woow_kanban__create_btn" t-on-click="() => this.openCreateModal()">
                        <WoowIcon name="'add'" size="20"/>
                        <span>Create Task</span>
                    </button>
                </div>
            </t>

            <!-- Create Task Modal -->
            <CreateTaskModal t-if="state.showCreateModal"
                defaultProjectId="props.projectId"
                defaultStageId="state.defaultStageId"
                onClose.bind="closeCreateModal"
                onCreated.bind="onTaskCreated"/>
        </div>
    </t>
</templates>
